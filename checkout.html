<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout | Studio Style MCR</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/cart.css?v=4">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <a href="index.html" class="logo">STUDIO STYLE MCR</a>
    <nav class="nav">
      <i class="fas fa-search search-icon" onclick="toggleSearch()"></i>
      <a href="cart.html">Back to Cart</a>
    </nav>
  </header>

  <!-- CHECKOUT -->
  <section class="checkout-section">
    <div class="checkout-container">

      <!-- Checkout Form -->
      <div class="checkout-form">
        <h2>Delivery Details</h2>

        <form id="checkout-form">
          <div class="form-row">
            <div class="form-group">
              <label>First Name *</label>
              <input type="text" name="firstName" required>
            </div>
            <div class="form-group">
              <label>Last Name *</label>
              <input type="text" name="lastName" required>
            </div>
          </div>

          <div class="form-group">
            <label>Email *</label>
            <input type="email" name="email" required>
          </div>

          <div class="form-group">
            <label>Phone *</label>
            <input type="tel" name="phone" required>
          </div>

          <div class="form-group">
            <label>Address *</label>
            <input type="text" name="address" required placeholder="House number and street">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>City *</label>
              <input type="text" name="city" required>
            </div>
            <div class="form-group">
              <label>Postcode *</label>
              <input type="text" name="postcode" required>
            </div>
          </div>

          <h2>Delivery Options</h2>

          <div class="delivery-options">
            <label class="delivery-option">
              <input type="radio" name="delivery" value="standard" checked>
              <span class="option-content">
                <span class="option-name">Standard Delivery</span>
                <span class="option-price">£3.99</span>
                <span class="option-time">3-5 working days</span>
              </span>
            </label>
            <label class="delivery-option">
              <input type="radio" name="delivery" value="express">
              <span class="option-content">
                <span class="option-name">Express Delivery</span>
                <span class="option-price">£5.99</span>
                <span class="option-time">1-2 working days</span>
              </span>
            </label>
            <label class="delivery-option">
              <input type="radio" name="delivery" value="free" id="free-delivery" disabled>
              <span class="option-content">
                <span class="option-name">Free Delivery</span>
                <span class="option-price">FREE</span>
                <span class="option-time">Orders over £100</span>
              </span>
            </label>
          </div>

          <button type="submit" class="pay-btn" id="pay-btn">
            Pay Now - <span id="final-total">£0.00</span>
          </button>
        </form>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <h2>Order Summary</h2>
        <div id="checkout-items" class="checkout-items"></div>
        <div class="summary-totals">
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="checkout-subtotal">£0.00</span>
          </div>
          <div class="summary-row">
            <span>Delivery</span>
            <span id="checkout-delivery">£3.99</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="checkout-total">£0.00</span>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-top">
      <div class="footer-brand">
        <div class="footer-logo">STUDIO STYLE MCR</div>
        <p>Women's fashion boutique based in Manchester. Curated style, delivered to your door.</p>
      </div>
      <div class="footer-column">
        <h4>Shop</h4>
        <a href="new-arrivals.html">New In</a>
        <a href="accessories.html">Accessories</a>
        <a href="last-chance.html">Last Chance</a>
        <a href="shop.html">All Products</a>
      </div>
      <div class="footer-column">
        <h4>Info</h4>
        <a href="about.html">About Us</a>
        <a href="contact.html">Contact</a>
        <a href="style-quiz.html">Style Quiz</a>
        <a href="returns.html">Returns</a>
        <a href="click-collect.html">Click &amp; Collect</a>
        <a href="login.html">My Account</a>
      </div>
      <div class="footer-column">
        <h4>Connect</h4>
        <a href="https://www.instagram.com/the_studio_mcr?igsh=Zmd3NXVvbGNvOXh4" target="_blank"><i class="fab fa-instagram"></i> Instagram</a>
        <a href="https://www.facebook.com/share/1D38Co16cq/?mibextid=wwXIfr" target="_blank"><i class="fab fa-facebook"></i> Facebook</a>
        <a href="https://www.tiktok.com/@thestudiomcr?_r=1&amp;_t=ZN-93QigICnc4E" target="_blank"><i class="fab fa-tiktok"></i> TikTok</a>
        <a href="https://wa.me/447802725901" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a>
      </div>
    </div>
    <div class="payment-methods">
      <div class="payment-icons">
        <i class="fab fa-cc-visa"></i>
        <i class="fab fa-cc-mastercard"></i>
        <i class="fab fa-apple-pay"></i>
        <i class="fab fa-google-pay"></i>
        <i class="fab fa-klarna"></i>
      </div>
    </div>
    <p class="copyright">&copy; 2026 Studio Style MCR. All rights reserved.</p>
  </footer>

  <!-- Search Overlay -->
  <div class="search-overlay" id="searchOverlay">
    <button class="search-close" onclick="closeSearch()">&times;</button>
    <div class="search-input-wrap">
      <input type="text" id="searchInput" placeholder="Search products..." oninput="performSearch()">
    </div>
    <div class="search-results" id="searchResults"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="js/products.js"></script>
  <script src="js/cart.js"></script>
  <script src="js/search.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // Delivery prices
    const deliveryPrices = {
      standard: 3.99,
      express: 5.99,
      free: 0
    };

    // Render checkout items
    function renderCheckout() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const checkoutItems = document.getElementById('checkout-items');
      const subtotalEl = document.getElementById('checkout-subtotal');
      const deliveryEl = document.getElementById('checkout-delivery');
      const totalEl = document.getElementById('checkout-total');
      const finalTotalEl = document.getElementById('final-total');
      const freeDelivery = document.getElementById('free-delivery');

      if (cart.length === 0) {
        window.location.href = 'cart.html';
        return;
      }

      // Render items
      checkoutItems.innerHTML = cart.map(item => `
        <div class="checkout-item">
          <div class="checkout-item-image">
            ${item.image ? `<img src="${item.image}" alt="${item.name}">` : ''}
          </div>
          <div class="checkout-item-details">
            <h4>${item.name}</h4>
            <p>Qty: ${item.quantity}</p>
          </div>
          <div class="checkout-item-price">£${(item.price * item.quantity).toFixed(2)}</div>
        </div>
      `).join('');

      // Calculate subtotal
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      subtotalEl.textContent = `£${subtotal.toFixed(2)}`;

      // Enable free delivery if over £50
      if (subtotal >= 100) {
        freeDelivery.disabled = false;
        freeDelivery.checked = true;
      }

      updateTotal();
    }

    // Update total based on delivery selection
    function updateTotal() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const delivery = document.querySelector('input[name="delivery"]:checked').value;
      const deliveryCost = deliveryPrices[delivery];

      document.getElementById('checkout-delivery').textContent = deliveryCost === 0 ? 'FREE' : `£${deliveryCost.toFixed(2)}`;
      const total = subtotal + deliveryCost;
      document.getElementById('checkout-total').textContent = `£${total.toFixed(2)}`;
      document.getElementById('final-total').textContent = `£${total.toFixed(2)}`;
    }

    // Listen for delivery option changes
    document.querySelectorAll('input[name="delivery"]').forEach(radio => {
      radio.addEventListener('change', updateTotal);
    });

    // Handle form submission
    document.getElementById('checkout-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const payBtn = document.getElementById('pay-btn');
      payBtn.disabled = true;
      payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      // Get form data
      const formData = new FormData(this);
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const delivery = formData.get('delivery');

      // Prepare customer info
      const customerInfo = {
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        address: formData.get('address'),
        city: formData.get('city'),
        postcode: formData.get('postcode')
      };

      try {
        // Call Stripe Checkout API
        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            items: cart,
            customerInfo: customerInfo,
            deliveryOption: delivery
          })
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        // Redirect to Stripe Checkout
        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error('No checkout URL returned');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        alert('Payment failed: ' + error.message + '. Please try again.');
        payBtn.disabled = false;
        payBtn.innerHTML = 'Pay Now - <span id="final-total">£' + document.getElementById('checkout-total').textContent.replace('£', '') + '</span>';
      }
    });

    // Initialize
    renderCheckout();
  </script>

</body>
</html>
