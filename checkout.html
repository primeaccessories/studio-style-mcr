<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout | Studio Style MCR</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/cart.css?v=5">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <a href="index.html" class="logo">STUDIO STYLE MCR</a>
    <nav class="nav">
      <i class="fas fa-search search-icon" onclick="toggleSearch()"></i>
      <a href="cart.html">Back to Cart</a>
    </nav>
  </header>

  <!-- CHECKOUT -->
  <section class="checkout-section">
    <div class="checkout-container">

      <!-- Checkout Form -->
      <div class="checkout-form">
        <h2>Delivery Details</h2>

        <form id="checkout-form">
          <div class="form-row">
            <div class="form-group">
              <label>First Name *</label>
              <input type="text" name="firstName" required>
            </div>
            <div class="form-group">
              <label>Last Name *</label>
              <input type="text" name="lastName" required>
            </div>
          </div>

          <div class="form-group">
            <label>Email *</label>
            <input type="email" name="email" required>
          </div>

          <div class="form-group">
            <label>Phone *</label>
            <input type="tel" name="phone" required>
          </div>

          <div class="form-group">
            <label>Address *</label>
            <input type="text" name="address" required placeholder="House number and street">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>City *</label>
              <input type="text" name="city" required>
            </div>
            <div class="form-group">
              <label>Postcode *</label>
              <input type="text" name="postcode" required>
            </div>
          </div>

          <h2>How would you like to receive your order?</h2>

          <div class="delivery-options">
            <div class="delivery-option-wrap">
              <label class="delivery-option">
                <input type="radio" name="delivery" value="local">
                <span class="option-content">
                  <span class="option-name">Collection / Drop-off</span>
                  <span class="option-price">FREE</span>
                  <span class="option-time">Collect or M28 drop-off</span>
                </span>
              </label>
              <div id="local-options" class="local-options" style="display:none;">
                <select id="localTypeSelect" class="local-select">
                  <option value="" disabled selected>Choose an option...</option>
                  <option value="collection">Collection</option>
                  <option value="dropoff">Drop-off (M28 only)</option>
                </select>
                <div id="dropoff-postcode" style="display:none;">
                  <input type="text" id="localPostcode" class="local-postcode-input" placeholder="Enter your postcode (e.g. M28 3AA)">
                </div>
                <div id="delivery-message" class="delivery-message" style="display:none;"></div>
              </div>
            </div>
            <label class="delivery-option">
              <input type="radio" name="delivery" value="standard" checked>
              <span class="option-content">
                <span class="option-name">Standard Delivery</span>
                <span class="option-price">£3.99</span>
                <span class="option-time">3-5 working days</span>
              </span>
            </label>
            <label class="delivery-option">
              <input type="radio" name="delivery" value="express">
              <span class="option-content">
                <span class="option-name">Express Delivery</span>
                <span class="option-price">£5.99</span>
                <span class="option-time">1-2 working days</span>
              </span>
            </label>
            <label class="delivery-option" id="free-delivery-label" style="display:none;">
              <input type="radio" name="delivery" value="free" id="free-delivery">
              <span class="option-content">
                <span class="option-name">Free Delivery</span>
                <span class="option-price">FREE</span>
                <span class="option-time">Orders over £100</span>
              </span>
            </label>
          </div>

          <div id="pay-buttons">
            <button type="submit" class="pay-btn" id="pay-btn">
              Pay Now - <span id="final-total">£0.00</span>
            </button>
          </div>
          <div id="local-pay-buttons" class="local-pay-buttons" style="display:none;">
            <button type="button" class="pay-btn pay-cash-btn" id="pay-cash-btn">
              Pay Cash - <span class="local-total">£0.00</span>
            </button>
            <button type="button" class="pay-btn pay-card-btn" id="pay-card-btn">
              Pay by Card - <span class="local-total">£0.00</span>
            </button>
          </div>
        </form>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <h2>Order Summary</h2>
        <div id="checkout-items" class="checkout-items"></div>
        <div class="summary-totals">
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="checkout-subtotal">£0.00</span>
          </div>
          <div class="summary-row">
            <span>Delivery</span>
            <span id="checkout-delivery">£3.99</span>
          </div>
          <div class="summary-row reward-row" id="reward-row" style="display: none; color: #2e7d32;">
            <span>Reward Discount</span>
            <span id="checkout-reward">-£20.00</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="checkout-total">£0.00</span>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-top">
      <div class="footer-brand">
        <div class="footer-logo">STUDIO STYLE MCR</div>
        <p>Women's fashion boutique based in Manchester. Curated style, delivered to your door.</p>
      </div>
      <div class="footer-column">
        <h4>Shop</h4>
        <a href="new-arrivals.html">New In</a>
        <a href="accessories.html">Accessories</a>
        <a href="last-chance.html">Last Chance</a>
        <a href="shop.html">All Products</a>
      </div>
      <div class="footer-column">
        <h4>Info</h4>
        <a href="about.html">About Us</a>
        <a href="contact.html">Contact</a>
        <a href="style-quiz.html">Style Quiz</a>
        <a href="returns.html">Returns</a>
        <a href="click-collect.html">Click &amp; Collect</a>
        <a href="login.html">My Account</a>
      </div>
      <div class="footer-column">
        <h4>Connect</h4>
        <a href="https://www.instagram.com/the_studio_mcr?igsh=Zmd3NXVvbGNvOXh4" target="_blank"><i class="fab fa-instagram"></i> Instagram</a>
        <a href="https://www.facebook.com/share/1D38Co16cq/?mibextid=wwXIfr" target="_blank"><i class="fab fa-facebook"></i> Facebook</a>
        <a href="https://www.tiktok.com/@thestudiomcr?_r=1&amp;_t=ZN-93QigICnc4E" target="_blank"><i class="fab fa-tiktok"></i> TikTok</a>
        <a href="https://wa.me/447802725901" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a>
      </div>
    </div>
    <div class="payment-methods">
      <div class="payment-icons">
        <i class="fab fa-cc-visa"></i>
        <i class="fab fa-cc-mastercard"></i>
        <i class="fab fa-apple-pay"></i>
        <i class="fab fa-google-pay"></i>
        <i class="fab fa-klarna"></i>
      </div>
    </div>
    <p class="copyright">&copy; 2026 Studio Style MCR. All rights reserved.</p>
  </footer>

  <!-- Search Overlay -->
  <div class="search-overlay" id="searchOverlay">
    <button class="search-close" onclick="closeSearch()">&times;</button>
    <div class="search-input-wrap">
      <input type="text" id="searchInput" placeholder="Search products..." oninput="performSearch()">
    </div>
    <div class="search-results" id="searchResults"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="js/products.js"></script>
  <script src="js/cart.js"></script>
  <script src="js/search.js"></script>
  <script src="js/auth.js?v=2"></script>
  <script>
    const deliveryPrices = {
      local: 0,
      standard: 3.99,
      express: 5.99,
      free: 0
    };

    let rewardAvailable = false;

    // Check for reward on page load
    auth.onAuthStateChanged(async function(user) {
      if (user) {
        try {
          const doc = await db.collection('users').doc(user.uid).get();
          if (doc.exists) {
            const data = doc.data();
            rewardAvailable = (data.rewards && data.rewards.rewardAvailable) || false;
            if (rewardAvailable) {
              document.getElementById('reward-row').style.display = 'flex';
            }
            updateTotal();
          }
        } catch (error) {
          console.error('Error checking reward:', error);
        }
      }
    });

    const addressInput = document.querySelector('input[name="address"]');
    const addressGroup = addressInput.closest('.form-group');
    const cityPostcodeRow = document.querySelector('input[name="city"]').closest('.form-row');

    function showAddressFields(show) {
      addressGroup.style.display = show ? '' : 'none';
      cityPostcodeRow.style.display = show ? '' : 'none';
      if (show) {
        addressInput.setAttribute('required', '');
        document.querySelector('input[name="city"]').setAttribute('required', '');
        document.querySelector('input[name="postcode"]').setAttribute('required', '');
      } else {
        addressInput.removeAttribute('required');
        document.querySelector('input[name="city"]').removeAttribute('required');
        document.querySelector('input[name="postcode"]').removeAttribute('required');
      }
    }

    function handleDeliveryChange() {
      const delivery = document.querySelector('input[name="delivery"]:checked').value;
      const messageEl = document.getElementById('delivery-message');
      const localOptions = document.getElementById('local-options');
      const payBtn = document.getElementById('pay-btn');

      if (delivery === 'local') {
        localOptions.style.display = 'block';
        handleLocalTypeChange();
      } else {
        // standard, express, free
        localOptions.style.display = 'none';
        showAddressFields(true);
        messageEl.style.display = 'none';
        payBtn.disabled = false;
      }

      updateTotal();
    }

    function handleLocalTypeChange() {
      const select = document.getElementById('localTypeSelect');
      const localType = select.value;
      const dropoffPostcode = document.getElementById('dropoff-postcode');
      const messageEl = document.getElementById('delivery-message');

      if (!localType) {
        dropoffPostcode.style.display = 'none';
        showAddressFields(false);
        messageEl.style.display = 'block';
        messageEl.className = 'delivery-message info';
        messageEl.textContent = 'Please choose collection or drop-off';
      } else if (localType === 'collection') {
        dropoffPostcode.style.display = 'none';
        showAddressFields(false);
        messageEl.style.display = 'block';
        messageEl.className = 'delivery-message success';
        messageEl.textContent = 'Collection available';
      } else {
        dropoffPostcode.style.display = 'block';
        showAddressFields(true);
        validateDropoffPostcode();
      }

      updateTotal();
    }

    function validateDropoffPostcode() {
      const postcode = document.getElementById('localPostcode').value.trim().toUpperCase().replace(/\s/g, '');
      const messageEl = document.getElementById('delivery-message');
      const payBtn = document.getElementById('pay-btn');

      if (!postcode) {
        messageEl.style.display = 'block';
        messageEl.className = 'delivery-message info';
        messageEl.textContent = 'Enter your postcode to check drop-off availability';
        payBtn.disabled = true;
        return;
      }

      if (postcode.startsWith('M28')) {
        messageEl.style.display = 'block';
        messageEl.className = 'delivery-message success';
        messageEl.textContent = 'Free drop-off delivery available for your area!';
        payBtn.disabled = false;
        // Auto-fill the postcode field in the form
        document.querySelector('input[name="postcode"]').value = document.getElementById('localPostcode').value;
      } else {
        messageEl.style.display = 'block';
        messageEl.className = 'delivery-message error';
        messageEl.textContent = 'Drop-off is not available for your area. Please select Collection or use our postal delivery service.';
        payBtn.disabled = true;
      }
    }

    function renderCheckout() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const checkoutItems = document.getElementById('checkout-items');
      const subtotalEl = document.getElementById('checkout-subtotal');
      const freeDelivery = document.getElementById('free-delivery');

      if (cart.length === 0) {
        window.location.href = 'cart.html';
        return;
      }

      checkoutItems.innerHTML = cart.map(item => `
        <div class="checkout-item">
          <div class="checkout-item-image">
            ${item.image ? `<img src="${item.image}" alt="${item.name}">` : ''}
          </div>
          <div class="checkout-item-details">
            <h4>${item.name}</h4>
            <p>Qty: ${item.quantity}</p>
          </div>
          <div class="checkout-item-price">£${(item.price * item.quantity).toFixed(2)}</div>
        </div>
      `).join('');

      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      subtotalEl.textContent = `£${subtotal.toFixed(2)}`;

      if (subtotal >= 100) {
        document.getElementById('free-delivery-label').style.display = '';
        freeDelivery.checked = true;
      } else {
        document.getElementById('free-delivery-label').style.display = 'none';
        if (freeDelivery.checked) {
          document.querySelector('input[name="delivery"][value="standard"]').checked = true;
        }
      }

      updateTotal();
      handleDeliveryChange();
    }

    function getActiveDeliveryType() {
      const delivery = document.querySelector('input[name="delivery"]:checked').value;
      if (delivery === 'local') {
        return document.getElementById('localTypeSelect').value || 'collection';
      }
      return delivery;
    }

    function updateTotal() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const delivery = document.querySelector('input[name="delivery"]:checked').value;
      const deliveryCost = deliveryPrices[delivery];

      document.getElementById('checkout-delivery').textContent = deliveryCost === 0 ? 'FREE' : `£${deliveryCost.toFixed(2)}`;

      let total = subtotal + deliveryCost;

      // Apply £20 reward discount if available
      const rewardDiscount = rewardAvailable ? Math.min(20, total) : 0;
      if (rewardAvailable) {
        document.getElementById('checkout-reward').textContent = `-£${rewardDiscount.toFixed(2)}`;
        total = Math.max(0, total - 20);
      }

      document.getElementById('checkout-total').textContent = `£${total.toFixed(2)}`;
      document.getElementById('final-total').textContent = `£${total.toFixed(2)}`;

      const payBtn = document.getElementById('pay-btn');
      const activeType = getActiveDeliveryType();
      const payButtons = document.getElementById('pay-buttons');
      const localPayButtons = document.getElementById('local-pay-buttons');

      const delivery2 = document.querySelector('input[name="delivery"]:checked').value;
      if (delivery2 === 'local') {
        payButtons.style.display = 'none';
        const localType = document.getElementById('localTypeSelect').value;
        if (localType === 'collection' || localType === 'dropoff') {
          localPayButtons.style.display = 'flex';
        } else {
          localPayButtons.style.display = 'none';
        }
        document.querySelectorAll('.local-total').forEach(el => el.textContent = '£' + total.toFixed(2));
      } else {
        payButtons.style.display = 'block';
        localPayButtons.style.display = 'none';
      }
    }

    document.querySelectorAll('input[name="delivery"]').forEach(radio => {
      radio.addEventListener('change', handleDeliveryChange);
    });

    document.getElementById('localTypeSelect').addEventListener('change', handleLocalTypeChange);

    document.getElementById('localPostcode').addEventListener('input', validateDropoffPostcode);

    function getCustomerInfo() {
      const formData = new FormData(document.getElementById('checkout-form'));
      return {
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        address: formData.get('address') || 'Collection',
        city: formData.get('city') || '',
        postcode: formData.get('postcode') || ''
      };
    }

    // Pay Cash button
    document.getElementById('pay-cash-btn').addEventListener('click', async function() {
      const form = document.getElementById('checkout-form');
      if (!form.reportValidity()) return;

      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const activeType = getActiveDeliveryType();
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const finalTotal = rewardAvailable ? Math.max(0, subtotal - 20) : subtotal;

      try {
        const user = auth.currentUser;
        const orderData = {
          items: cart,
          customerInfo: getCustomerInfo(),
          deliveryOption: activeType,
          paymentMethod: 'cash',
          total: finalTotal,
          rewardUsed: rewardAvailable,
          status: 'pending',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (user) {
          await db.collection('users').doc(user.uid).collection('orders').add(orderData);

          // Update rewards: increment count and reset reward if used
          const userDoc = await db.collection('users').doc(user.uid).get();
          const userData = userDoc.data();
          const currentCount = (userData.rewards && userData.rewards.orderCount) || 0;
          const newCount = currentCount + 1;

          const rewardUpdate = {
            'rewards.orderCount': newCount
          };

          // If reward was used, reset it. Otherwise check if new reward earned.
          if (rewardAvailable) {
            rewardUpdate['rewards.rewardAvailable'] = false;
          } else if (newCount % 5 === 0) {
            rewardUpdate['rewards.rewardAvailable'] = true;
          }

          await db.collection('users').doc(user.uid).update(rewardUpdate);
        }

        localStorage.removeItem('cart');
        window.location.href = 'order-confirmation.html?method=' + activeType;
      } catch (error) {
        console.error('Order error:', error);
        alert('Order failed: ' + error.message);
        this.disabled = false;
        this.innerHTML = 'Pay Cash - <span class="local-total">£' + document.getElementById('checkout-total').textContent.replace('£', '') + '</span>';
      }
    });

    // Pay Card button (local collection/dropoff)
    document.getElementById('pay-card-btn').addEventListener('click', async function() {
      const form = document.getElementById('checkout-form');
      if (!form.reportValidity()) return;

      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const activeType = getActiveDeliveryType();

      try {
        const user = auth.currentUser;
        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            items: cart,
            customerInfo: getCustomerInfo(),
            deliveryOption: activeType,
            rewardUsed: rewardAvailable,
            userId: user ? user.uid : null
          })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error);
        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error('No checkout URL returned');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        alert('Payment failed: ' + error.message + '. Please try again.');
        this.disabled = false;
        this.innerHTML = 'Pay by Card - <span class="local-total">£' + document.getElementById('checkout-total').textContent.replace('£', '') + '</span>';
      }
    });

    // Pay Now button (standard/express/free delivery)
    document.getElementById('checkout-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const activeType = getActiveDeliveryType();
      if (activeType === 'collection' || activeType === 'dropoff') return;

      const payBtn = document.getElementById('pay-btn');
      payBtn.disabled = true;
      payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      const cart = JSON.parse(localStorage.getItem('cart')) || [];

      try {
        const user = auth.currentUser;
        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            items: cart,
            customerInfo: getCustomerInfo(),
            deliveryOption: activeType,
            rewardUsed: rewardAvailable,
            userId: user ? user.uid : null
          })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error);
        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error('No checkout URL returned');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        alert('Payment failed: ' + error.message + '. Please try again.');
        payBtn.disabled = false;
        payBtn.innerHTML = 'Pay Now - <span id="final-total">£' + document.getElementById('checkout-total').textContent.replace('£', '') + '</span>';
      }
    });

    renderCheckout();
  </script>

</body>
</html>
