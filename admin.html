<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Admin | Studio Style MCR</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; touch-action: pan-y; }
    body {
      font-family: 'Fjalla One', sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      touch-action: pan-y;
      overscroll-behavior: none;
    }

    /* LOGIN */
    .login-screen {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: #0a0a0a;
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .login-screen.hidden { display: none; }
    .login-box { text-align: center; width: 340px; max-width: 90%; }
    .login-logo { font-size: 1.4rem; letter-spacing: 4px; color: #fff; margin-bottom: 10px; }
    .login-sub { font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; color: #555; margin-bottom: 40px; }
    .login-input {
      width: 100%; padding: 14px 20px;
      background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
      color: #fff; font-family: inherit; font-size: 0.85rem;
      letter-spacing: 3px; text-align: center; outline: none;
      transition: border-color 0.3s; margin-bottom: 15px;
    }
    .login-input::placeholder { color: #555; letter-spacing: 2px; }
    .login-input:focus { border-color: rgba(255,255,255,0.3); }
    .login-btn {
      width: 100%; padding: 14px; background: #fff; color: #000;
      border: none; font-family: inherit; font-size: 0.75rem;
      letter-spacing: 2px; text-transform: uppercase; cursor: pointer;
    }
    .login-btn:hover { background: #e0e0e0; }
    .login-error { color: #e74c3c; font-size: 0.75rem; letter-spacing: 1px; margin-top: 15px; opacity: 0; transition: opacity 0.3s; }
    .login-error.show { opacity: 1; }
    .login-back { display: inline-block; margin-top: 30px; color: #444; font-size: 0.7rem; letter-spacing: 1px; text-decoration: none; }
    .login-back:hover { color: #fff; }

    /* ADMIN PANEL */
    .admin-panel { display: none; }
    .admin-panel.show { display: block; }

    .admin-header {
      background: #0a0a0a; color: #fff; padding: 20px 30px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .admin-header-left { display: flex; align-items: center; gap: 15px; }
    .admin-header-logo { font-size: 1rem; letter-spacing: 3px; }
    .admin-badge { font-size: 0.6rem; letter-spacing: 1.5px; text-transform: uppercase; background: rgba(255,255,255,0.1); padding: 4px 10px; color: #999; }
    .admin-header-right { display: flex; gap: 20px; align-items: center; }
    .admin-header-right a { color: #777; font-size: 0.7rem; letter-spacing: 1px; text-decoration: none; text-transform: uppercase; }
    .admin-header-right a:hover { color: #fff; }
    .admin-logout {
      background: none; border: 1px solid rgba(255,255,255,0.15); color: #999;
      padding: 8px 16px; font-family: inherit; font-size: 0.65rem;
      letter-spacing: 1.5px; text-transform: uppercase; cursor: pointer;
    }
    .admin-logout:hover { border-color: #fff; color: #fff; }

    .admin-body { max-width: 1200px; margin: 0 auto; padding: 30px; }

    /* STATS */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #fff; padding: 25px; border: 1px solid #eee; }
    .stat-label { font-size: 0.65rem; letter-spacing: 2px; text-transform: uppercase; color: #999; margin-bottom: 10px; }
    .stat-value { font-size: 1.8rem; color: #333; }
    .stat-sub { font-size: 0.7rem; color: #aaa; margin-top: 5px; }

    /* MAIN TABS */
    .admin-tabs { display: flex; gap: 0; margin-bottom: 0; background: #2c2c2c; border: none; }
    .admin-tab {
      padding: 15px 30px; font-family: inherit; font-size: 0.7rem;
      letter-spacing: 1.5px; text-transform: uppercase; cursor: pointer;
      background: transparent; border: none; color: rgba(255,255,255,0.6); transition: all 0.2s;
    }
    .admin-tab.active { color: #fff; background: #444; }
    .admin-tab:hover { color: #fff; }

    /* SUB TABS */
    .admin-subtabs { display: flex; gap: 0; background: #f5f5f5; border: 1px solid #eee; border-bottom: none; }
    .admin-subtab {
      padding: 12px 20px; font-family: inherit; font-size: 0.65rem;
      letter-spacing: 1px; text-transform: uppercase; cursor: pointer;
      background: transparent; border: none; color: #999; transition: all 0.2s;
      border-bottom: 2px solid transparent;
    }
    .admin-subtab.active { color: #000; border-bottom-color: #000; background: #fff; }
    .admin-subtab:hover { color: #333; }
    .subtab-count {
      display: inline-block; background: #eee; color: #666;
      font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; margin-left: 5px;
    }
    .admin-subtab.active .subtab-count { background: #000; color: #fff; }

    .tab-content { display: none; background: #fff; border: 1px solid #eee; }
    .tab-content.active { display: block; }
    .tab-content.has-subtabs { border-top: none; }

    /* TOOLBAR */
    .admin-toolbar {
      padding: 15px 25px; border-bottom: 1px solid #eee;
      display: flex; justify-content: space-between; align-items: center;
    }
    .toolbar-left { display: flex; gap: 10px; align-items: center; }
    .admin-search {
      padding: 8px 15px; border: 1px solid #ddd; font-family: inherit;
      font-size: 0.8rem; outline: none; width: 250px;
    }
    .admin-search:focus { border-color: #999; }
    .filter-select {
      padding: 8px 15px; border: 1px solid #ddd; font-family: inherit;
      font-size: 0.8rem; outline: none; background: #fff; cursor: pointer;
    }
    .add-btn, .bulk-sizes-btn {
      padding: 10px 20px; background: #000; color: #fff; border: none;
      font-family: inherit; font-size: 0.7rem; letter-spacing: 1.5px;
      text-transform: uppercase; cursor: pointer;
    }
    .add-btn:hover, .bulk-sizes-btn:hover { background: #333; }
    .bulk-sizes-btn { background: #2c2c2c; }

    /* BULK SIZES MODAL */
    .bulk-modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 2000; display: none;
      align-items: flex-start; justify-content: center; padding: 30px 15px;
      overflow-y: auto;
    }
    .bulk-modal-overlay.show { display: flex; }
    .bulk-modal {
      background: #fff; width: 100%; max-width: 900px; border-radius: 6px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 30px;
    }
    .bulk-modal-header {
      padding: 20px 25px; border-bottom: 1px solid #eee;
      display: flex; justify-content: space-between; align-items: center;
    }
    .bulk-modal-header h2 { font-size: 1rem; letter-spacing: 2px; }
    .bulk-modal-close {
      background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;
    }
    .bulk-modal-close:hover { color: #000; }
    .bulk-modal-body { padding: 20px 25px; max-height: 70vh; overflow-y: auto; }
    .bulk-modal-footer {
      padding: 15px 25px; border-top: 1px solid #eee;
      display: flex; justify-content: flex-end; gap: 10px;
    }
    .bulk-save-btn {
      padding: 12px 30px; background: #2e7d32; color: #fff; border: none;
      font-family: inherit; font-size: 0.7rem; letter-spacing: 1.5px;
      text-transform: uppercase; cursor: pointer; border-radius: 3px;
    }
    .bulk-save-btn:hover { background: #1b5e20; }
    .bulk-cancel-btn {
      padding: 12px 30px; background: #eee; color: #333; border: none;
      font-family: inherit; font-size: 0.7rem; letter-spacing: 1.5px;
      text-transform: uppercase; cursor: pointer; border-radius: 3px;
    }
    .bulk-table { width: 100%; border-collapse: collapse; }
    .bulk-table th {
      font-size: 0.6rem; letter-spacing: 1px; text-transform: uppercase;
      color: #999; padding: 8px 4px; border-bottom: 2px solid #eee;
      text-align: center; font-weight: 400; position: sticky; top: 0; background: #fff;
    }
    .bulk-table th:first-child { text-align: left; padding-left: 10px; min-width: 180px; }
    .bulk-table td { padding: 6px 4px; border-bottom: 1px solid #f5f5f5; text-align: center; }
    .bulk-table td:first-child { text-align: left; padding-left: 10px; font-size: 0.8rem; color: #333; }
    .bulk-table input[type="number"] {
      width: 42px; padding: 4px 2px; text-align: center; border: 1px solid #ddd;
      border-radius: 3px; font-size: 0.8rem; font-family: inherit;
    }
    .bulk-table input[type="number"]:focus { border-color: #666; outline: none; }
    .bulk-no-sizes { color: #c53030; font-size: 0.65rem; }
    .bulk-has-sizes { color: #2e7d32; font-size: 0.65rem; }

    /* PRODUCT TABLE */
    .product-table { width: 100%; border-collapse: collapse; }
    .product-table th {
      text-align: left; font-size: 0.65rem; letter-spacing: 1.5px;
      text-transform: uppercase; color: #999; padding: 12px 25px;
      border-bottom: 1px solid #eee; font-weight: 400;
    }
    .product-table td {
      padding: 12px 25px; border-bottom: 1px solid #f5f5f5;
      font-size: 0.85rem; color: #555; vertical-align: middle;
    }
    .product-table tr:hover { background: #fafafa; }
    .product-thumb { width: 40px; height: 40px; object-fit: cover; margin-right: 10px; vertical-align: middle; }
    .product-name { color: #333; }
    .collection-badge {
      display: inline-block; padding: 3px 10px;
      font-size: 0.6rem; letter-spacing: 1px; text-transform: uppercase;
    }
    .badge-new { background: #e3f2fd; color: #1565c0; }
    .badge-last-chance { background: #fff3e0; color: #e65100; }
    .badge-accessories { background: #f3e5f5; color: #7b1fa2; }
    .badge-yet-live { background: #fff3e0; color: #e65100; }
    .status-active { display: inline-block; padding: 3px 10px; background: #e8f5e9; color: #2e7d32; font-size: 0.65rem; letter-spacing: 1px; text-transform: uppercase; }
    .status-sale { display: inline-block; padding: 3px 10px; background: #fff3e0; color: #e65100; font-size: 0.65rem; letter-spacing: 1px; text-transform: uppercase; }
    .was-price { text-decoration: line-through; color: #bbb; margin-right: 5px; }
    .action-btns { display: flex; gap: 8px; }
    .edit-btn, .delete-btn, .dupe-btn {
      padding: 5px 12px; font-family: inherit; font-size: 0.6rem;
      letter-spacing: 1px; text-transform: uppercase; cursor: pointer; border: 1px solid #ddd;
      background: #fff; color: #555; transition: all 0.2s;
    }
    .edit-btn:hover { border-color: #000; color: #000; }
    .dupe-btn:hover { border-color: #1565c0; color: #1565c0; }
    .delete-btn:hover { border-color: #e74c3c; color: #e74c3c; }
    .actions-menu-btn {
      display: none; padding: 6px 14px; font-family: inherit; font-size: 0.65rem;
      letter-spacing: 1px; text-transform: uppercase; cursor: pointer;
      border: 1px solid #ddd; background: #fff; color: #555;
    }
    .action-popup {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 600; align-items: flex-end; justify-content: center;
    }
    .action-popup.show { display: flex; }
    .action-popup-menu {
      background: #fff; width: 100%; max-width: 500px; padding: 0;
      border-radius: 12px 12px 0 0; overflow: hidden;
    }
    .action-popup-title {
      padding: 16px 20px; font-size: 0.7rem; letter-spacing: 2px;
      text-transform: uppercase; color: #999; border-bottom: 1px solid #eee;
    }
    .action-popup-item {
      display: flex; align-items: center; gap: 12px; width: 100%;
      padding: 16px 20px; font-family: inherit; font-size: 0.85rem;
      border: none; background: #fff; color: #333; cursor: pointer;
      text-align: left; border-bottom: 1px solid #f5f5f5;
    }
    .action-popup-item:active { background: #f5f5f5; }
    .action-popup-item i { width: 20px; text-align: center; color: #999; }
    .action-popup-item.danger { color: #e74c3c; }
    .action-popup-item.danger i { color: #e74c3c; }
    .action-popup-cancel {
      display: block; width: 100%; padding: 16px; font-family: inherit;
      font-size: 0.75rem; letter-spacing: 1.5px; text-transform: uppercase;
      border: none; background: #f5f5f5; color: #555; cursor: pointer;
      text-align: center;
    }

    /* DRAG REORDER */
    .reorder-cell { width: 40px; text-align: center; }
    .drag-handle {
      cursor: grab; padding: 8px; color: #ccc; font-size: 1.1rem;
      transition: color 0.2s; display: inline-block;
    }
    .drag-handle:hover { color: #666; }
    .drag-handle:active { cursor: grabbing; }
    .product-table tr.dragging { opacity: 0.5; background: #f0f0f0; }
    .product-table tr.drag-over { border-top: 2px solid #000; }
    .product-table tr.drag-over-below { border-bottom: 2px solid #000; }

    /* MODAL */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 500; display: none;
      align-items: center; justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #fff; width: 500px; max-width: 95%; max-height: 90vh;
      overflow-y: auto; padding: 30px;
    }
    .modal h2 {
      font-size: 0.85rem; letter-spacing: 2px; text-transform: uppercase;
      margin-bottom: 25px; color: #333; font-weight: 400;
    }
    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block; font-size: 0.65rem; letter-spacing: 1.5px;
      text-transform: uppercase; color: #999; margin-bottom: 6px;
    }
    .form-input {
      width: 100%; padding: 10px 14px; border: 1px solid #ddd;
      font-family: inherit; font-size: 0.85rem; color: #333; outline: none;
    }
    .form-input:focus { border-color: #999; }
    .form-select {
      width: 100%; padding: 10px 14px; border: 1px solid #ddd;
      font-family: inherit; font-size: 0.85rem; color: #333;
      outline: none; background: #fff; cursor: pointer;
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-checkbox { display: flex; align-items: center; gap: 10px; margin: 15px 0; }
    .form-checkbox input { width: 16px; height: 16px; cursor: pointer; }
    .form-checkbox label { font-size: 0.8rem; color: #555; cursor: pointer; margin-bottom: 0; letter-spacing: 0; text-transform: none; }
    .sale-fields { display: none; padding: 15px; background: #fff9f0; border: 1px solid #ffe0b2; margin-bottom: 18px; }
    .sale-fields.show { display: block; }
    .modal-actions { display: flex; gap: 10px; margin-top: 25px; }
    .modal-save {
      padding: 12px 30px; background: #000; color: #fff; border: none;
      font-family: inherit; font-size: 0.7rem; letter-spacing: 2px;
      text-transform: uppercase; cursor: pointer;
    }
    .modal-save:hover { background: #333; }
    .modal-cancel {
      padding: 12px 30px; background: #fff; color: #555; border: 1px solid #ddd;
      font-family: inherit; font-size: 0.7rem; letter-spacing: 2px;
      text-transform: uppercase; cursor: pointer;
    }
    .modal-cancel:hover { border-color: #999; }
    .image-upload-area {
      border: 2px dashed #ddd; padding: 30px; text-align: center;
      cursor: pointer; transition: all 0.2s; background: #fafafa;
    }
    .image-upload-area:hover, .image-upload-area.dragover {
      border-color: #999; background: #f0f0f0;
    }
    .upload-placeholder i { font-size: 2rem; color: #ccc; margin-bottom: 10px; }
    .upload-placeholder p { font-size: 0.8rem; color: #777; margin-bottom: 4px; }
    .upload-placeholder span { font-size: 0.65rem; color: #bbb; letter-spacing: 1px; }
    .upload-preview { position: relative; display: inline-block; }
    .upload-preview img { max-width: 200px; max-height: 200px; object-fit: cover; border: 1px solid #eee; }
    .remove-image {
      position: absolute; top: -8px; right: -8px;
      width: 24px; height: 24px; background: #e74c3c; color: #fff;
      border: none; border-radius: 50%; font-size: 1rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      line-height: 1;
    }
    .upload-preview img { cursor: zoom-in; }
    .image-lightbox {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); display: none; align-items: center;
      justify-content: center; z-index: 2000; cursor: zoom-out;
    }
    .image-lightbox.show { display: flex; }
    .image-lightbox img {
      max-width: 90vw; max-height: 90vh; object-fit: contain;
      border: 2px solid rgba(255,255,255,0.1); border-radius: 4px;
    }

    /* TOAST NOTIFICATION */
    .admin-toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: #333; color: #fff; padding: 14px 28px; border-radius: 10px;
      font-family: inherit; font-size: 0.8rem; letter-spacing: 0.5px;
      z-index: 3000; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 8px 30px rgba(0,0,0,0.15); pointer-events: none;
    }
    .admin-toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .admin-toast i { margin-right: 8px; }

    /* APPLE-STYLE CONFIRMATION DIALOG */
    .confirm-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); z-index: 2500;
      display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    }
    .confirm-overlay.show { display: flex; }
    .confirm-dialog {
      background: rgba(255,255,255,0.95); border-radius: 14px;
      width: 300px; max-width: 90%; text-align: center;
      overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      animation: confirmPop 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes confirmPop {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .confirm-body { padding: 22px 20px 10px; }
    .confirm-title {
      font-size: 1rem; font-weight: 600; color: #1a1a1a;
      margin-bottom: 6px; letter-spacing: 0.3px;
    }
    .confirm-message {
      font-size: 0.8rem; color: #666; line-height: 1.5;
      font-weight: 400; letter-spacing: 0;
    }
    .confirm-actions {
      display: flex; border-top: 1px solid rgba(0,0,0,0.1);
    }
    .confirm-btn {
      flex: 1; padding: 14px; border: none; background: none;
      font-family: inherit; font-size: 0.9rem; cursor: pointer;
      transition: background 0.15s; letter-spacing: 0;
    }
    .confirm-btn:first-child { border-right: 1px solid rgba(0,0,0,0.1); }
    .confirm-btn.cancel { color: #007aff; font-weight: 400; }
    .confirm-btn.cancel:hover { background: rgba(0,0,0,0.04); }
    .confirm-btn.destructive { color: #ff3b30; font-weight: 600; }
    .confirm-btn.destructive:hover { background: rgba(255,59,48,0.06); }
    .confirm-btn.primary { color: #007aff; font-weight: 600; }
    .confirm-btn.primary:hover { background: rgba(0,122,255,0.06); }

    /* MULTI-IMAGE UPLOAD */
    .multi-image-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 10px; margin-top: 10px;
    }
    .multi-image-item {
      position: relative; aspect-ratio: 1; border: 1px solid #eee;
      border-radius: 6px; overflow: hidden; cursor: pointer;
    }
    .multi-image-item img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .multi-image-item .remove-img-btn {
      position: absolute; top: 4px; right: 4px;
      width: 20px; height: 20px; background: rgba(231,76,60,0.9); color: #fff;
      border: none; border-radius: 50%; font-size: 0.75rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      line-height: 1; opacity: 0; transition: opacity 0.2s;
    }
    .multi-image-item:hover .remove-img-btn { opacity: 1; }
    .multi-image-item.primary { border: 2px solid #007aff; }
    .multi-image-item .primary-label {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(0,122,255,0.85); color: #fff;
      font-size: 0.55rem; text-align: center; padding: 2px;
      letter-spacing: 1px; text-transform: uppercase;
    }
    .add-image-slot {
      aspect-ratio: 1; border: 2px dashed #ddd; border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; background: #fafafa;
    }
    .add-image-slot:hover { border-color: #999; background: #f0f0f0; }
    .add-image-slot i { font-size: 1.2rem; color: #ccc; }

    /* GO LIVE INDIVIDUAL BUTTON */
    .go-live-btn {
      padding: 4px 10px; background: #2e7d32; color: #fff; border: none;
      font-family: inherit; font-size: 0.55rem; letter-spacing: 1px;
      text-transform: uppercase; cursor: pointer; border-radius: 3px;
      transition: background 0.2s;
    }
    .go-live-btn:hover { background: #1b5e20; }
    .lightbox-close {
      position: absolute; top: 20px; right: 25px;
      background: none; border: none; color: #fff; font-size: 2rem;
      cursor: pointer; opacity: 0.7; transition: opacity 0.2s;
    }
    .lightbox-close:hover { opacity: 1; }
    .url-toggle { text-align: center; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .url-toggle span { font-size: 0.7rem; color: #bbb; }
    .url-toggle-btn {
      background: none; border: none; color: #999; font-family: inherit;
      font-size: 0.7rem; cursor: pointer; text-decoration: underline;
    }
    .url-toggle-btn:hover { color: #333; }
    .url-input-wrap { margin-top: 10px; }

    /* SHOW MORE */
    .table-container {
      position: relative;
    }
    .table-container.collapsed tbody tr:nth-child(n+6) {
      display: none;
    }
    .table-container.collapsed::after {
      content: '';
      position: absolute;
      bottom: 50px;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(transparent, white);
      pointer-events: none;
    }
    .show-more-btn {
      display: block;
      width: 100%;
      padding: 15px;
      background: #f8f8f8;
      border: none;
      border-top: 1px solid #eee;
      font-family: inherit;
      font-size: 0.7rem;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
    }
    .show-more-btn:hover {
      background: #f0f0f0;
      color: #333;
    }
    .show-more-btn i {
      margin-left: 8px;
      transition: transform 0.2s;
    }
    .table-container:not(.collapsed) .show-more-btn i {
      transform: rotate(180deg);
    }

    /* BOOKINGS */
    .bookings-container { padding: 25px; }

    /* Summary Strip */
    .bookings-summary {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
      margin-bottom: 25px; padding: 18px 20px; background: #fafafa; border: 1px solid #eee;
    }
    .summary-item { text-align: center; }
    .summary-item-label {
      font-size: 0.6rem; letter-spacing: 1.5px; text-transform: uppercase;
      color: #999; margin-bottom: 6px;
    }
    .summary-item-value { font-size: 1.1rem; color: #333; }
    .summary-item-value.highlight { color: #2e7d32; }
    .summary-item-sub { font-size: 0.7rem; color: #888; margin-top: 2px; }

    /* Availability Note */
    .availability-note {
      font-size: 0.7rem; color: #888; letter-spacing: 0.5px;
      margin-bottom: 15px; padding: 10px 12px; background: #f8f8f8;
      border-left: 3px solid #ddd;
    }

    .bookings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .bookings-title { font-size: 0.75rem; letter-spacing: 2px; text-transform: uppercase; color: #333; }

    .booking-card {
      background: #fafafa; border: 1px solid #eee; padding: 20px;
      margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-start;
      transition: background 0.15s, border-color 0.15s;
    }
    .booking-card:hover { background: #f5f5f5; border-color: #ddd; }
    .booking-card:focus { outline: 2px solid #333; outline-offset: 2px; }
    .booking-info { flex: 1; }
    .booking-client-name { font-size: 1rem; font-weight: 400; color: #333; margin-bottom: 4px; }
    .booking-datetime { font-size: 0.8rem; color: #666; margin-bottom: 8px; }
    .booking-occasion {
      display: inline-block; font-size: 0.65rem; letter-spacing: 1px;
      padding: 3px 8px; background: #f0f0f0; color: #666; margin-top: 6px;
    }
    .booking-meta { display: flex; align-items: center; gap: 12px; margin-left: 20px; }
    .booking-status {
      padding: 5px 12px; font-size: 0.65rem; letter-spacing: 1px;
      text-transform: uppercase; border: none;
    }
    .status-pending { background: #fff3e0; color: #e65100; }
    .status-confirmed { background: #e8f5e9; color: #2e7d32; }
    .status-completed { background: #e3f2fd; color: #1565c0; }
    .status-cancelled { background: #ffebee; color: #c62828; }
    .booking-actions { display: flex; gap: 6px; }
    .booking-action-btn {
      padding: 6px 10px; background: #fff; border: 1px solid #ddd;
      font-family: inherit; font-size: 0.6rem; letter-spacing: 0.5px;
      text-transform: uppercase; cursor: pointer; color: #666; transition: all 0.15s;
    }
    .booking-action-btn:hover { border-color: #333; color: #333; }
    .booking-action-btn:focus { outline: 2px solid #333; outline-offset: 1px; }
    .booking-action-btn.confirm { background: #e3f2fd; border-color: #bbdefb; color: #1565c0; }
    .booking-action-btn.confirm:hover { background: #bbdefb; }
    .booking-action-btn.complete { background: #e8f5e9; border-color: #c8e6c9; color: #2e7d32; }
    .booking-action-btn.complete:hover { background: #c8e6c9; }
    .booking-action-btn.delete { background: #ffebee; border-color: #ffcdd2; color: #c62828; }
    .booking-action-btn.delete:hover { background: #ffcdd2; }
    .status-confirmed { background: #e3f2fd; color: #1565c0; }

    /* Empty State */
    .no-bookings {
      text-align: center; padding: 60px 30px; color: #666;
    }
    .no-bookings-icon { font-size: 2.5rem; color: #ddd; margin-bottom: 15px; }
    .no-bookings-title { font-size: 0.9rem; color: #333; margin-bottom: 8px; letter-spacing: 1px; }
    .no-bookings-text { font-size: 0.8rem; color: #888; line-height: 1.6; max-width: 320px; margin: 0 auto; }

    /* Calendar */
    .calendar-view { margin-bottom: 30px; }
    .calendar-nav { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
    .calendar-nav button {
      padding: 8px 15px; background: #fff; border: 1px solid #ddd;
      font-family: inherit; font-size: 0.7rem; cursor: pointer; transition: all 0.15s;
    }
    .calendar-nav button:hover { border-color: #333; }
    .calendar-nav button:focus { outline: 2px solid #333; outline-offset: 1px; }
    .calendar-month { font-size: 0.85rem; letter-spacing: 1px; }

    .calendar-grid {
      display: grid; grid-template-columns: repeat(7, 1fr);
      gap: 1px; background: #e5e5e5; border: 1px solid #e5e5e5;
    }
    .calendar-header {
      background: #333; color: #fff; padding: 10px;
      text-align: center; font-size: 0.65rem; letter-spacing: 1px; text-transform: uppercase;
    }
    .calendar-header.weekend { background: #555; color: #999; }

    .calendar-day {
      background: #fff; min-height: 70px; padding: 8px;
      font-size: 0.75rem; position: relative; cursor: pointer;
      transition: background 0.15s;
    }
    .calendar-day:hover:not(.disabled):not(.other-month) { background: #f8f8f8; }
    .calendar-day:focus { outline: 2px solid #333; outline-offset: -2px; z-index: 1; }
    .calendar-day.other-month { background: #fafafa; cursor: default; }
    .calendar-day.disabled { background: #f5f5f5; cursor: not-allowed; opacity: 0.5; }
    .calendar-day.today { background: #f0f7ff; }
    .calendar-day.selected { background: #333; }
    .calendar-day.selected .calendar-day-number { color: #fff; }
    .calendar-day.selected .calendar-day-indicator { background: #fff; }

    .calendar-day-number { font-weight: 400; margin-bottom: 4px; color: #333; }
    .calendar-day.other-month .calendar-day-number { color: #ccc; }
    .calendar-day.disabled .calendar-day-number { color: #bbb; }

    /* Booking indicators */
    .calendar-day-indicators { display: flex; gap: 3px; margin-top: 4px; }
    .calendar-day-indicator {
      width: 6px; height: 6px; border-radius: 50%; background: #e65100;
    }
    .calendar-day-indicator.confirmed { background: #2e7d32; }
    .calendar-day.fully-booked { background: #e8f5e9; }
    .calendar-day.fully-booked.selected { background: #333; }

    /* Tooltip */
    .calendar-day[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: #333; color: #fff; padding: 5px 10px; border-radius: 3px;
      font-size: 0.65rem; white-space: nowrap; z-index: 10;
      pointer-events: none;
    }
    .calendar-day[data-tooltip]:hover::before {
      content: '';
      position: absolute; bottom: calc(100% - 5px); left: 50%; transform: translateX(-50%);
      border: 5px solid transparent; border-top-color: #333; z-index: 10;
    }

    /* Slot View Panel */
    .slot-view-panel {
      margin-top: 20px; padding: 20px; background: #fafafa; border: 1px solid #eee;
      display: none;
    }
    .slot-view-panel.show { display: block; }
    .slot-view-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid #eee;
    }
    .slot-view-title { font-size: 0.85rem; color: #333; }
    .slot-view-date { font-size: 0.7rem; color: #888; letter-spacing: 0.5px; }
    .slot-view-close {
      background: none; border: none; font-size: 1.2rem; color: #999;
      cursor: pointer; line-height: 1;
    }
    .slot-view-close:hover { color: #333; }

    .slots-grid { display: flex; flex-direction: column; gap: 8px; }
    .slot-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 15px; background: #fff; border: 1px solid #eee;
      transition: all 0.15s;
    }
    .slot-item.booked { border-left: 3px solid #2e7d32; }
    .slot-item.available { border-left: 3px solid #ddd; }
    .slot-time { font-size: 0.8rem; color: #333; min-width: 100px; }
    .slot-status { font-size: 0.7rem; color: #888; flex: 1; }
    .slot-status.booked { color: #333; font-weight: 500; }
    .slot-action-btn {
      padding: 5px 10px; background: #fff; border: 1px solid #ddd;
      font-family: inherit; font-size: 0.6rem; letter-spacing: 0.5px;
      text-transform: uppercase; cursor: pointer; color: #666;
    }
    .slot-action-btn:hover { border-color: #333; color: #333; }

    .calendar-booking {
      font-size: 0.6rem; padding: 3px 5px; margin-bottom: 2px;
      border-radius: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      cursor: pointer;
    }
    .calendar-booking.pending { background: #fff3e0; color: #e65100; }
    .calendar-booking.confirmed { background: #e8f5e9; color: #2e7d32; }
    .calendar-booking.completed { background: #e3f2fd; color: #1565c0; }
    .calendar-booking.cancelled { background: #ffebee; color: #c62828; text-decoration: line-through; }

    /* BOOKING DETAIL MODAL */
    .booking-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 600; display: none;
      align-items: center; justify-content: center;
    }
    .booking-modal.show { display: flex; }
    .booking-modal-content {
      background: #fff; width: 450px; max-width: 95%; padding: 30px;
      max-height: 90vh; overflow-y: auto;
    }
    .booking-modal-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 25px;
    }
    .booking-modal-title {
      font-size: 1.2rem; color: #333; font-weight: 400;
    }
    .booking-modal-close {
      background: none; border: none; font-size: 1.5rem;
      cursor: pointer; color: #999; line-height: 1;
    }
    .booking-modal-close:hover { color: #333; }
    .booking-detail-row {
      display: flex; justify-content: space-between;
      padding: 12px 0; border-bottom: 1px solid #f0f0f0;
    }
    .booking-detail-row:last-child { border-bottom: none; }
    .booking-detail-label {
      font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; color: #999;
    }
    .booking-detail-value {
      font-size: 0.9rem; color: #333; text-align: right; max-width: 60%;
    }
    .booking-detail-value.large {
      font-size: 1.1rem; font-weight: 500;
    }
    .whatsapp-btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: #25D366; color: #fff; padding: 12px 20px;
      border: none; border-radius: 4px; font-family: inherit;
      font-size: 0.75rem; letter-spacing: 1px; text-transform: uppercase;
      cursor: pointer; text-decoration: none; margin-top: 20px; width: 100%;
      justify-content: center;
    }
    .whatsapp-btn:hover { background: #20bd5a; }
    .whatsapp-btn i { font-size: 1.1rem; }
    .calendar-nav { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .calendar-nav button {
      padding: 8px 15px; background: #fff; border: 1px solid #ddd;
      font-family: inherit; font-size: 0.7rem; cursor: pointer;
    }
    .calendar-nav button:hover { border-color: #333; }
    .calendar-month { font-size: 0.85rem; letter-spacing: 1px; }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 15px; }
      .stat-card { padding: 12px; }
      .stat-value { font-size: 1.2rem; }
      .stat-label { font-size: 0.55rem; margin-bottom: 4px; }
      .stat-sub { font-size: 0.6rem; margin-top: 2px; }
      .admin-header { flex-direction: column; gap: 8px; text-align: center; padding: 12px; }
      .admin-header-right { gap: 12px; }
      .admin-body { padding: 10px 8px; }
      .admin-toolbar { flex-direction: column; gap: 8px; padding: 10px 12px; }
      .toolbar-left { flex-direction: column; width: 100%; }
      .admin-search { width: 100%; }
      .add-btn { width: 100%; text-align: center; }
      .product-thumb { width: 30px; height: 30px; margin-right: 6px; border-radius: 3px; }
      .form-row { grid-template-columns: 1fr; }
      .admin-tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .admin-tab { padding: 10px 14px; white-space: nowrap; font-size: 0.6rem; }
      .admin-subtabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .admin-subtab { padding: 8px 12px; white-space: nowrap; font-size: 0.6rem; }
      .reorder-cell, .product-table th:first-child { display: none; }
      .product-table th { padding: 8px 6px; font-size: 0.55rem; letter-spacing: 1px; }
      .product-table td { padding: 8px 6px; font-size: 0.75rem; }
      #productsTab .action-btns .edit-btn, #productsTab .action-btns .delete-btn, #productsTab .action-btns .dupe-btn { display: none; }
      #productsTab .action-btns .go-live-btn { display: inline-block; }
      .actions-menu-btn { display: inline-block; }
      #discountsTab .action-btns, #ordersTab .action-btns { flex-wrap: wrap; }
      #discountsTab .action-btns .edit-btn, #discountsTab .action-btns .delete-btn,
      #ordersTab .action-btns .edit-btn, #ordersTab .action-btns .delete-btn { display: inline-block; font-size: 0.6rem; padding: 4px 8px; }
      .collection-badge { font-size: 0.5rem; padding: 2px 5px; }
      .status-active, .status-sale { font-size: 0.55rem; padding: 2px 6px; }
      .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 500; overflow-y: auto; -webkit-overflow-scrolling: touch; touch-action: pan-y; padding: 0; }
      .modal-overlay.show { display: block; }
      .modal { padding: 20px 15px; width: 100%; max-width: 100%; max-height: none; border-radius: 0; overflow-y: visible; min-height: 100vh; }
      .modal h2 { font-size: 0.75rem; }
      .modal-save, .modal-cancel { width: 100%; }
      .modal-actions { flex-direction: column; gap: 8px; }
      .image-upload-area { padding: 15px 10px; }
      .tab-content { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .size-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 6px !important; }
      .size-grid .size-cell { padding: 6px 8px !important; }
      .size-grid .size-cell span { min-width: 40px !important; font-size: 0.75rem !important; }
      .size-grid .size-cell input { width: 50px !important; padding: 5px 4px !important; font-size: 0.8rem !important; }
    }
    @media (max-width: 480px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .admin-header-logo { font-size: 0.85rem; }
      .admin-badge { font-size: 0.5rem; }
      .product-table td { padding: 6px 4px; font-size: 0.7rem; }
      .product-table th { padding: 6px 4px; }
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <div class="login-logo">STUDIO STYLE MCR</div>
      <div class="login-sub">Admin Portal</div>
      <form onsubmit="attemptLogin(event)">
        <input type="password" class="login-input" id="loginPassword" placeholder="Enter password" autocomplete="off">
        <button type="submit" class="login-btn">Unlock</button>
      </form>
      <div class="login-error" id="loginError">Incorrect password</div>
      <a href="index.html" class="login-back">&larr; Back to site</a>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="admin-panel" id="adminPanel">
    <div class="admin-header">
      <div class="admin-header-left">
        <div class="admin-header-logo">STUDIO STYLE MCR</div>
        <span class="admin-badge">Admin</span>
        <span id="firebaseStatus" style="font-size: 0.55rem; letter-spacing: 1px; padding: 3px 8px; border-radius: 10px; background: #555; color: #999;">CONNECTING...</span>
        <button onclick="forceSync()" style="font-size: 0.5rem; letter-spacing: 1px; padding: 3px 8px; border-radius: 10px; background: rgba(255,255,255,0.1); color: #999; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; font-family: inherit; text-transform: uppercase;">Sync</button>
      </div>
      <div class="admin-header-right">
        <a href="index.html">View Site</a>
        <button class="admin-logout" onclick="adminLogout()">Logout</button>
      </div>
    </div>

    <div class="admin-body">
      <!-- SALES STATS -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Today's Sales</div>
          <div class="stat-value" id="statSalesToday">£0</div>
          <div class="stat-sub">Revenue</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">This Week</div>
          <div class="stat-value" id="statSalesWeek">£0</div>
          <div class="stat-sub">Revenue</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">This Month</div>
          <div class="stat-value" id="statSalesMonth">£0</div>
          <div class="stat-sub">Revenue</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Orders</div>
          <div class="stat-value" id="statOrdersTotal">0</div>
          <div class="stat-sub">All time</div>
        </div>
      </div>

      <!-- MAIN TABS -->
      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchMainTab('products', this)">Products</button>
        <button class="admin-tab" onclick="switchMainTab('sales', this)">Sales</button>
        <button class="admin-tab" onclick="switchMainTab('bookings', this)">Bookings</button>
        <button class="admin-tab" onclick="switchMainTab('discounts', this)">Discounts</button>
      </div>

      <!-- PRODUCT SUB-TABS -->
      <div class="admin-subtabs" id="productSubtabs">
        <button class="admin-subtab active" onclick="switchSubTab('all', this)">All <span class="subtab-count" id="countAll">0</span></button>
        <button class="admin-subtab" onclick="switchSubTab('new-arrivals', this)">What's New <span class="subtab-count" id="countNew">0</span></button>
        <button class="admin-subtab" onclick="switchSubTab('last-chance', this)">Last Chance <span class="subtab-count" id="countLastChance">0</span></button>
        <button class="admin-subtab" onclick="switchSubTab('accessories', this)">Accessories <span class="subtab-count" id="countAccessories">0</span></button>
        <button class="admin-subtab" onclick="switchSubTab('yet-to-go-live', this)">Yet to go Live <span class="subtab-count" id="countYetToGoLive">0</span></button>
      </div>

      <!-- PRODUCT LIST -->
      <div class="tab-content active has-subtabs" id="productList">
        <div class="admin-toolbar">
          <div class="toolbar-left">
            <input type="text" class="admin-search" id="searchInput" placeholder="Search products..." oninput="renderTable()">
          </div>
          <div style="display:flex;gap:8px;">
            <button class="bulk-sizes-btn" onclick="openBulkSizes()"><i class="fas fa-ruler"></i> &nbsp;Bulk Sizes</button>
            <button class="add-btn" onclick="openAddModal()"><i class="fas fa-plus"></i> &nbsp;Add Product</button>
          </div>
        </div>
        <div id="goLiveBar" style="display:none; background:#2e7d32; color:#fff; padding:14px 20px; margin-bottom:10px; align-items:center; justify-content:space-between; border-radius:4px;">
          <span style="font-size:0.8rem; letter-spacing:1px;">These products are hidden until you go live. Use the <strong>Live</strong> button on each product or push all at once.</span>
          <button onclick="goLive()" style="background:#fff; color:#2e7d32; border:none; padding:10px 24px; font-family:inherit; font-size:0.75rem; letter-spacing:1.5px; text-transform:uppercase; cursor:pointer; font-weight:bold;">GO LIVE ALL</button>
        </div>
        <div class="table-container collapsed" id="tableContainer">
          <div style="overflow-x:auto;">
            <table class="product-table">
              <thead>
                <tr>
                  <th class="reorder-cell"></th>
                  <th>Product</th>
                  <th>Price</th>
                  <th>Qty</th>
                  <th>Collection</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="productTableBody"></tbody>
            </table>
          </div>
          <button class="show-more-btn" id="showMoreBtn" onclick="toggleProductList()">
            Show All Products <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </div>

      <!-- SALES TAB -->
      <div class="tab-content" id="salesTab">
        <div class="bookings-container">
          <!-- Sales Summary -->
          <div class="bookings-summary">
            <div class="summary-item">
              <div class="summary-item-label">Today</div>
              <div class="summary-item-value" id="salesToday">£0</div>
              <div class="summary-item-sub">revenue</div>
            </div>
            <div class="summary-item">
              <div class="summary-item-label">This Week</div>
              <div class="summary-item-value" id="salesWeek">£0</div>
              <div class="summary-item-sub">revenue</div>
            </div>
            <div class="summary-item">
              <div class="summary-item-label">Total Orders</div>
              <div class="summary-item-value" id="salesTotal">0</div>
              <div class="summary-item-sub">all time</div>
            </div>
          </div>

          <!-- Orders Table -->
          <div style="overflow-x:auto; margin-top: 20px;">
            <table class="product-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Customer</th>
                  <th>Items</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="salesTableBody">
                <tr><td colspan="6" style="text-align:center; padding: 30px; color: #999;">Loading orders...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="sales-pagination" id="salesPagination" style="display: none; padding: 20px; text-align: center;">
            <button class="add-btn" onclick="loadMorePayments()" id="loadMoreBtn">Load More Orders</button>
          </div>
        </div>
      </div>

      <!-- BOOKINGS TAB -->
      <div class="tab-content" id="bookingsTab">
        <div class="bookings-container">
          <!-- Summary Strip -->
          <div class="bookings-summary" role="region" aria-label="Booking statistics">
            <div class="summary-item">
              <div class="summary-item-label">Today</div>
              <div class="summary-item-value" id="summaryToday">0</div>
              <div class="summary-item-sub">bookings</div>
            </div>
            <div class="summary-item">
              <div class="summary-item-label">This Week</div>
              <div class="summary-item-value" id="summaryWeek">0 / 12</div>
              <div class="summary-item-sub">slots filled</div>
            </div>
            <div class="summary-item">
              <div class="summary-item-label">Next Booking</div>
              <div class="summary-item-value highlight" id="summaryNext">—</div>
              <div class="summary-item-sub" id="summaryNextTime"></div>
            </div>
          </div>

          <!-- Calendar -->
          <div class="calendar-view" role="region" aria-label="Booking calendar">
            <div class="availability-note">
              <i class="fas fa-info-circle"></i> Available Mon, Wed, Fri — 10am–2pm (4 sessions per day)
            </div>
            <div class="calendar-nav">
              <button onclick="prevMonth()" aria-label="Previous month">&larr; Prev</button>
              <span class="calendar-month" id="calendarMonth" aria-live="polite">January 2026</span>
              <button onclick="nextMonth()" aria-label="Next month">Next &rarr;</button>
            </div>
            <div class="calendar-grid" id="calendarGrid" role="grid" aria-label="Calendar"></div>
          </div>

          <!-- Slot View Panel -->
          <div class="slot-view-panel" id="slotViewPanel" role="region" aria-label="Day slots">
            <div class="slot-view-header">
              <div>
                <div class="slot-view-title" id="slotViewTitle">Monday</div>
                <div class="slot-view-date" id="slotViewDate">27 January 2026</div>
              </div>
              <button class="slot-view-close" onclick="closeSlotView()" aria-label="Close slot view">&times;</button>
            </div>
            <div class="slots-grid" id="slotsGrid"></div>
          </div>

          <!-- Bookings List -->
          <div class="bookings-header">
            <div class="bookings-title">All Bookings</div>
          </div>
          <div id="bookingsList" role="list" aria-label="Bookings list"></div>
        </div>
      </div>

      <!-- DISCOUNTS TAB -->
      <div class="tab-content" id="discountsTab">
        <div class="bookings-container">
          <div class="admin-toolbar" style="margin-bottom: 20px;">
            <div class="toolbar-left">
              <h3 style="font-size: 0.9rem; letter-spacing: 1px;">Manage Discount Codes</h3>
            </div>
            <button class="add-btn" onclick="openDiscountModal()"><i class="fas fa-plus"></i> &nbsp;Add Code</button>
          </div>

          <div style="overflow-x:auto;">
            <table class="product-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Discount</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="discountTableBody">
                <tr><td colspan="5" style="text-align:center; padding: 30px; color: #999;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- DISCOUNT MODAL -->
  <div class="modal-overlay" id="discountModalOverlay" onclick="closeDiscountModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <h2 id="discountModalTitle">Add Discount Code</h2>

      <div class="form-group">
        <label>Code (e.g. SAVE10)</label>
        <input type="text" class="form-input" id="discountCode" placeholder="STUDIO10" style="text-transform: uppercase;">
      </div>

      <div class="form-group">
        <label>Discount Type</label>
        <select class="form-select" id="discountType">
          <option value="percent">Percentage (%)</option>
          <option value="fixed">Fixed Amount (£)</option>
        </select>
      </div>

      <div class="form-group">
        <label>Discount Value</label>
        <input type="number" class="form-input" id="discountValue" placeholder="10" step="1" min="1">
        <small style="color: #999; font-size: 0.7rem;">Enter 10 for 10% or £10</small>
      </div>

      <div class="form-checkbox">
        <input type="checkbox" id="discountEnabled" checked>
        <label for="discountEnabled">Code is active</label>
      </div>

      <div class="modal-actions">
        <button class="modal-save" onclick="saveDiscount()">Save Code</button>
        <button class="modal-cancel" onclick="closeDiscountModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- BULK SIZES MODAL -->
  <div class="bulk-modal-overlay" id="bulkSizesOverlay" onclick="closeBulkSizes()">
    <div class="bulk-modal" onclick="event.stopPropagation()">
      <div class="bulk-modal-header">
        <h2><i class="fas fa-ruler" style="margin-right:8px;color:#666;"></i> Bulk Size Editor</h2>
        <button class="bulk-modal-close" onclick="closeBulkSizes()">&times;</button>
      </div>
      <div class="bulk-modal-body">
        <p style="font-size:0.8rem;color:#666;margin-bottom:15px;">Set stock quantities for each size across all products. Leave blank or 0 for sizes not available.</p>
        <div id="bulkSizesTableWrap"></div>
      </div>
      <div class="bulk-modal-footer">
        <button class="bulk-cancel-btn" onclick="closeBulkSizes()">Cancel</button>
        <button class="bulk-save-btn" onclick="saveBulkSizes()"><i class="fas fa-save"></i> &nbsp;Save All</button>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <h2 id="modalTitle">Add Product</h2>

      <div class="form-group">
        <label>Product Name</label>
        <input type="text" class="form-input" id="formName" placeholder="e.g. COCOONS">
      </div>

      <div class="form-group">
        <label>Product Images</label>
        <div class="multi-image-grid" id="multiImageGrid">
          <!-- Images populated dynamically -->
        </div>
        <div class="image-upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click();" ondragover="event.preventDefault(); this.classList.add('dragover');" ondragleave="this.classList.remove('dragover');" ondrop="handleDrop(event);" style="margin-top:10px;">
          <div class="upload-placeholder" id="uploadPlaceholder">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click to upload or drag & drop</p>
            <span>JPG, PNG up to 5MB &bull; Add multiple images</span>
          </div>
        </div>
        <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileUpload(this)" multiple>
        <div class="url-toggle">
          <span>or</span>
          <button type="button" class="url-toggle-btn" onclick="toggleUrlInput()">Paste image URL instead</button>
        </div>
        <div class="url-input-wrap" id="urlInputWrap" style="display:none;">
          <input type="text" class="form-input" id="formImage" placeholder="https://..." onkeydown="if(event.key==='Enter'){event.preventDefault();addUrlImage();}">
          <button type="button" style="margin-top:6px; padding:6px 14px; background:#000; color:#fff; border:none; font-family:inherit; font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; cursor:pointer;" onclick="addUrlImage()">Add Image</button>
        </div>
      </div>

      <div class="form-group">
        <label>Collections</label>
        <div class="size-checkboxes" id="collectionCheckboxes">
          <label class="size-checkbox"><input type="checkbox" id="colNewArrivals" value="new-arrivals"> What's New</label>
          <label class="size-checkbox"><input type="checkbox" id="colLastChance" value="last-chance"> Last Chance</label>
          <label class="size-checkbox"><input type="checkbox" id="colAccessories" value="accessories"> Accessories</label>
        </div>
      </div>

      <div class="form-checkbox" style="margin-top:4px; margin-bottom:12px; padding:10px 14px; background:#fffbe6; border:1px solid #f0e6b0; border-radius:8px;">
        <input type="checkbox" id="formYetToGoLive">
        <label for="formYetToGoLive" style="font-weight:600; color:#b8860b;">Yet to go Live <span style="font-weight:400; color:#999; font-size:0.75rem;">&mdash; hidden from customers until pushed live</span></label>
      </div>

      <div class="form-group">
        <label>Price (&pound;)</label>
        <input type="number" class="form-input" id="formPrice" placeholder="19.99" step="0.01">
      </div>

      <div class="form-group">
        <label>Description <span style="color: #e74c3c;">*</span></label>
        <textarea class="form-input" id="formDescription" placeholder="Describe the product - material, style, fit details..." rows="3" style="resize: vertical; min-height: 80px;"></textarea>
        <small style="color: #999; font-size: 0.7rem;">Required - Add unique details about this product</small>
      </div>

      <div class="form-checkbox">
        <input type="checkbox" id="formSale" onchange="toggleSaleFields()">
        <label for="formSale">This product is on sale</label>
      </div>

      <div class="sale-fields" id="saleFields">
        <div class="form-row">
          <div class="form-group">
            <label>Original Price (&pound;)</label>
            <input type="number" class="form-input" id="formOriginalPrice" placeholder="25.00" step="0.01">
          </div>
          <div class="form-group">
            <label>Sale Price (&pound;)</label>
            <input type="number" class="form-input" id="formSalePrice" placeholder="12.50" step="0.01">
          </div>
        </div>
      </div>

      <div class="form-group">
        <div onclick="toggleColourDropdown()" style="cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: #2c2c2c; border-radius: 6px; user-select: none; transition: background 0.2s;">
          <i class="fas fa-palette" style="color: #e8e0d6; font-size: 1rem;"></i>
          <span style="color: #fff; font-weight: 600; font-size: 0.85rem; letter-spacing: 0.5px; flex: 1;">Colours</span>
          <span id="colourDropdownBadge" style="font-size: 0.7rem; color: #bbb; font-weight: normal;"></span>
          <i id="colourDropdownArrow" class="fas fa-chevron-down" style="color: #bbb; font-size: 0.65rem; transition: transform 0.2s;"></i>
        </div>
        <div id="colourDropdownBody" style="display: none; padding-top: 10px;">
          <div id="colourTags" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px;"></div>
          <div style="display: flex; gap: 6px; align-items: center;">
            <input type="text" class="form-input" id="colourInput" placeholder="e.g. Black, Navy, Red..." style="flex: 1; padding: 8px 10px; font-size: 0.85rem;">
            <button type="button" onclick="addColour()" style="padding: 8px 14px; background: #e8e0d6; border: none; cursor: pointer; font-size: 0.75rem; letter-spacing: 1px; text-transform: uppercase;">Add</button>
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">
            <button type="button" class="colour-preset" onclick="addPresetColour('Black')" style="padding: 4px 10px; font-size: 0.7rem; background: #1a1a1a; color: #fff; border: none; border-radius: 12px; cursor: pointer;">Black</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('White')" style="padding: 4px 10px; font-size: 0.7rem; background: #fff; color: #333; border: 1px solid #ddd; border-radius: 12px; cursor: pointer;">White</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Navy')" style="padding: 4px 10px; font-size: 0.7rem; background: #1b2a4a; color: #fff; border: none; border-radius: 12px; cursor: pointer;">Navy</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Grey')" style="padding: 4px 10px; font-size: 0.7rem; background: #888; color: #fff; border: none; border-radius: 12px; cursor: pointer;">Grey</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Cream')" style="padding: 4px 10px; font-size: 0.7rem; background: #f5f0e6; color: #333; border: 1px solid #ddd; border-radius: 12px; cursor: pointer;">Cream</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Pink')" style="padding: 4px 10px; font-size: 0.7rem; background: #e8a0b4; color: #fff; border: none; border-radius: 12px; cursor: pointer;">Pink</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Red')" style="padding: 4px 10px; font-size: 0.7rem; background: #c53030; color: #fff; border: none; border-radius: 12px; cursor: pointer;">Red</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Blue')" style="padding: 4px 10px; font-size: 0.7rem; background: #2b6cb0; color: #fff; border: none; border-radius: 12px; cursor: pointer;">Blue</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Green')" style="padding: 4px 10px; font-size: 0.7rem; background: #2f855a; color: #fff; border: none; border-radius: 12px; cursor: pointer;">Green</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Brown')" style="padding: 4px 10px; font-size: 0.7rem; background: #744210; color: #fff; border: none; border-radius: 12px; cursor: pointer;">Brown</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Beige')" style="padding: 4px 10px; font-size: 0.7rem; background: #d4c5a9; color: #333; border: 1px solid #c5b696; border-radius: 12px; cursor: pointer;">Beige</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Khaki')" style="padding: 4px 10px; font-size: 0.7rem; background: #6b6b3d; color: #fff; border: none; border-radius: 12px; cursor: pointer;">Khaki</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Chocolate')" style="padding: 4px 10px; font-size: 0.7rem; background: #4a2c2a; color: #fff; border: none; border-radius: 12px; cursor: pointer;">Chocolate</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Gold')" style="padding: 4px 10px; font-size: 0.7rem; background: #c9a86c; color: #fff; border: none; border-radius: 12px; cursor: pointer;">Gold</button>
            <button type="button" class="colour-preset" onclick="addPresetColour('Silver')" style="padding: 4px 10px; font-size: 0.7rem; background: #b0b0b0; color: #333; border: 1px solid #999; border-radius: 12px; cursor: pointer;">Silver</button>
          </div>
          <small style="color: #999; font-size: 0.7rem; margin-top: 5px; display: block;">Click presets or type a custom colour name and click Add.</small>
        </div>
      </div>

      <div class="form-group" id="clothingSizesGroup">
        <label>Clothing Sizes & Stock</label>
        <div id="clothingSizesContainer"></div>
        <small style="color: #999; font-size: 0.7rem; margin-top: 5px; display: block;">Enter stock quantity per size. 0 or empty = not available.</small>
      </div>

      <div class="form-group">
        <label>Shoe Sizes & Stock</label>
        <div class="size-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;">
          <div class="size-cell" style="display: flex; align-items: center; gap: 6px; background: #fafafa; border: 1px solid #eee; padding: 8px 10px; border-radius: 4px;">
            <span style="font-size: 0.8rem; color: #555; min-width: 55px;">3</span>
            <input type="number" class="form-input" id="sizeQtyShoe3" placeholder="0" min="0" step="1" style="width: 60px; padding: 6px 8px; text-align: center; font-size: 0.85rem;">
          </div>
          <div class="size-cell" style="display: flex; align-items: center; gap: 6px; background: #fafafa; border: 1px solid #eee; padding: 8px 10px; border-radius: 4px;">
            <span style="font-size: 0.8rem; color: #555; min-width: 55px;">4</span>
            <input type="number" class="form-input" id="sizeQtyShoe4" placeholder="0" min="0" step="1" style="width: 60px; padding: 6px 8px; text-align: center; font-size: 0.85rem;">
          </div>
          <div class="size-cell" style="display: flex; align-items: center; gap: 6px; background: #fafafa; border: 1px solid #eee; padding: 8px 10px; border-radius: 4px;">
            <span style="font-size: 0.8rem; color: #555; min-width: 55px;">5</span>
            <input type="number" class="form-input" id="sizeQtyShoe5" placeholder="0" min="0" step="1" style="width: 60px; padding: 6px 8px; text-align: center; font-size: 0.85rem;">
          </div>
          <div class="size-cell" style="display: flex; align-items: center; gap: 6px; background: #fafafa; border: 1px solid #eee; padding: 8px 10px; border-radius: 4px;">
            <span style="font-size: 0.8rem; color: #555; min-width: 55px;">6</span>
            <input type="number" class="form-input" id="sizeQtyShoe6" placeholder="0" min="0" step="1" style="width: 60px; padding: 6px 8px; text-align: center; font-size: 0.85rem;">
          </div>
          <div class="size-cell" style="display: flex; align-items: center; gap: 6px; background: #fafafa; border: 1px solid #eee; padding: 8px 10px; border-radius: 4px;">
            <span style="font-size: 0.8rem; color: #555; min-width: 55px;">7</span>
            <input type="number" class="form-input" id="sizeQtyShoe7" placeholder="0" min="0" step="1" style="width: 60px; padding: 6px 8px; text-align: center; font-size: 0.85rem;">
          </div>
          <div class="size-cell" style="display: flex; align-items: center; gap: 6px; background: #fafafa; border: 1px solid #eee; padding: 8px 10px; border-radius: 4px;">
            <span style="font-size: 0.8rem; color: #555; min-width: 55px;">8</span>
            <input type="number" class="form-input" id="sizeQtyShoe8" placeholder="0" min="0" step="1" style="width: 60px; padding: 6px 8px; text-align: center; font-size: 0.85rem;">
          </div>
        </div>
        <small style="color: #999; font-size: 0.7rem; margin-top: 5px; display: block;">Enter stock for each shoe size. Leave at 0 for non-footwear.</small>
      </div>

      <div id="notifyBanner" style="display: none; background: #fffbeb; border: 1px solid #f0d060; border-radius: 6px; padding: 12px 16px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
          <i class="fas fa-bell" style="color: #c9a86c;"></i>
          <strong style="font-size: 0.85rem;" id="notifyBannerCount">0 people</strong>
          <span style="font-size: 0.8rem; color: #666;">want to know when this is back in stock</span>
        </div>
        <div id="notifyBannerEmails" style="font-size: 0.75rem; color: #555; max-height: 80px; overflow-y: auto;"></div>
        <button type="button" onclick="copyNotifyEmails()" style="margin-top: 8px; padding: 6px 14px; background: #2c2c2c; color: #fff; border: none; border-radius: 4px; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; cursor: pointer;">
          <i class="fas fa-copy"></i> Copy All Emails
        </button>
      </div>

      <div class="modal-actions">
        <button class="modal-save" onclick="saveProduct()">Save Product</button>
        <button class="modal-cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- BOOKING DETAIL MODAL -->
  <div class="booking-modal" id="bookingModal" onclick="closeBookingModal()">
    <div class="booking-modal-content" onclick="event.stopPropagation()">
      <div class="booking-modal-header">
        <div class="booking-modal-title">Booking Details</div>
        <button class="booking-modal-close" onclick="closeBookingModal()">&times;</button>
      </div>
      <div id="bookingModalBody"></div>
    </div>
  </div>

  <!-- Order Detail Modal -->
  <div class="modal-overlay" id="orderModalOverlay" onclick="closeOrderModal()">
    <div onclick="event.stopPropagation()" style="background:#f6f8fa; width:860px; max-width:95vw; max-height:92vh; overflow-y:auto; border-radius:8px; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <div id="orderModalBody"></div>
    </div>
  </div>

  <!-- Login script - isolated so nothing can break it -->
  <script>
    // Prevent pinch-to-zoom and double-tap zoom
    document.addEventListener('touchmove', function(e) {
      if (e.touches.length > 1) e.preventDefault();
    }, { passive: false });
    document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
    document.addEventListener('gesturechange', function(e) { e.preventDefault(); });
    document.addEventListener('gestureend', function(e) { e.preventDefault(); });
    // Prevent double-tap zoom
    var lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      var now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, false);

    var ADMIN_PASSWORD = 'admin123';

    function attemptLogin(e) {
      e.preventDefault();
      if (document.getElementById('loginPassword').value === ADMIN_PASSWORD) {
        sessionStorage.setItem('adminAuth', 'true');
        // Ensure Firebase Auth session exists (anonymous sign-in if not already signed in)
        if (typeof auth !== 'undefined' && !auth.currentUser) {
          auth.signInAnonymously().catch(function(err) {
            console.warn('Anonymous sign-in failed:', err);
          });
        }
        showDashboard();
      } else {
        document.getElementById('loginError').classList.add('show');
        document.getElementById('loginPassword').value = '';
        setTimeout(function() { document.getElementById('loginError').classList.remove('show'); }, 2000);
      }
    }
  </script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="js/products.js?v=3"></script>
  <script src="js/auth.js?v=3"></script>
  <script>
    // ============================================
    // FIREBASE STATUS INDICATOR
    // ============================================
    function updateFirebaseStatus(connected) {
      var el = document.getElementById('firebaseStatus');
      if (!el) return;
      if (connected) {
        el.textContent = 'SYNCED';
        el.style.background = '#1b5e20';
        el.style.color = '#4caf50';
      } else {
        el.textContent = 'OFFLINE';
        el.style.background = '#b71c1c';
        el.style.color = '#ef9a9a';
      }
    }

    // Ensure Firebase Auth session on load (anonymous if needed)
    (function() {
      if (typeof auth === 'undefined' || typeof db === 'undefined') {
        updateFirebaseStatus(false);
        return;
      }

      function checkConnection() {
        db.collection('siteData').doc('products').get()
          .then(function() { updateFirebaseStatus(true); })
          .catch(function() { updateFirebaseStatus(false); });
      }

      if (!auth.currentUser) {
        auth.signInAnonymously()
          .then(function() { checkConnection(); })
          .catch(function(err) {
            console.warn('Anonymous sign-in failed:', err);
            checkConnection();
          });
      } else {
        checkConnection();
      }
    })();

    // Force sync: pull latest from Firebase, overwrite localStorage, re-render
    function forceSync() {
      if (typeof db === 'undefined') {
        showAlert('No Connection', 'Firebase is not loaded. Try refreshing the page or check your internet connection.');
        return;
      }
      db.collection('siteData').doc('products').get()
        .then(function(doc) {
          if (doc.exists && doc.data().items) {
            var products = doc.data().items;
            localStorage.setItem('studioProducts', JSON.stringify(products));
            _productsCache = products;
            renderTable();
            updateFirebaseStatus(true);
            showToast('Synced ' + products.length + ' products from cloud');
          } else {
            showAlert('No Data', 'No products found in Firebase. If you have products locally, try saving one to push them to the cloud.');
          }
        })
        .catch(function(error) {
          updateFirebaseStatus(false);
          showAlert('Sync Failed', 'Could not reach Firebase: ' + error.message + '. Check your internet connection.');
        });
    }

    // ============================================
    // FIREBASE BOOKINGS - Real-time sync across all admin devices
    // ============================================
    var bookingsCache = []; // Local cache updated by real-time listener
    var bookingsUnsubscribe = null;

    // Initialize real-time bookings listener
    function initBookingsListener() {
      if (bookingsUnsubscribe) return; // Already listening

      bookingsUnsubscribe = db.collection('bookings')
        .orderBy('createdAt', 'desc')
        .onSnapshot(function(snapshot) {
          bookingsCache = [];
          snapshot.forEach(function(doc) {
            bookingsCache.push({ id: doc.id, ...doc.data() });
          });

          // Update UI if on bookings tab
          if (currentTab === 'bookings') {
            updateSummary();
            renderBookings();
            renderCalendar();
            if (selectedCalendarDate) {
              renderDaySlots(selectedCalendarDate);
            }
          }
        }, function(error) {
          console.error('Error listening to bookings:', error);
          // Fallback to localStorage if Firebase fails
          bookingsCache = JSON.parse(localStorage.getItem('studioBookings') || '[]');
        });
    }

    // Get bookings (from cache, updated in real-time)
    function getBookings() {
      return bookingsCache;
    }

    // Save booking to Firebase
    async function saveBookingToFirebase(booking) {
      try {
        if (booking.id && booking.id.length > 10) {
          // Update existing
          await db.collection('bookings').doc(booking.id).update(booking);
        } else {
          // Add new
          booking.id = Date.now().toString();
          await db.collection('bookings').add(booking);
        }
        return true;
      } catch (error) {
        console.error('Error saving booking:', error);
        return false;
      }
    }

    // Update booking status in Firebase
    async function updateBookingStatusInFirebase(bookingId, status) {
      try {
        // Find the document by querying for the booking id
        var snapshot = await db.collection('bookings')
          .where('id', '==', bookingId)
          .get();

        if (!snapshot.empty) {
          await snapshot.docs[0].ref.update({ status: status });
        }
        return true;
      } catch (error) {
        console.error('Error updating booking status:', error);
        return false;
      }
    }

    // Delete booking from Firebase
    async function deleteBookingFromFirebase(bookingId) {
      try {
        var snapshot = await db.collection('bookings')
          .where('id', '==', bookingId)
          .get();

        if (!snapshot.empty) {
          await snapshot.docs[0].ref.delete();
        }
        return true;
      } catch (error) {
        console.error('Error deleting booking:', error);
        return false;
      }
    }

    // Migrate localStorage bookings to Firebase (one-time)
    async function migrateLocalBookingsToFirebase() {
      var localBookings = JSON.parse(localStorage.getItem('studioBookings') || '[]');
      if (localBookings.length === 0) return;

      console.log('Migrating ' + localBookings.length + ' bookings to Firebase...');

      for (var i = 0; i < localBookings.length; i++) {
        var booking = localBookings[i];
        // Check if already exists in Firebase
        var exists = bookingsCache.some(function(b) { return b.id === booking.id; });
        if (!exists) {
          await db.collection('bookings').add({
            ...booking,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }

      // Clear localStorage after migration
      localStorage.removeItem('studioBookings');
      console.log('Migration complete!');
    }
    var currentTab = 'all';
    var editingId = null;

    function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('adminPanel').classList.add('show');

      // Initialize Firebase real-time listener for bookings
      initBookingsListener();

      // Migrate any existing localStorage bookings to Firebase (one-time)
      setTimeout(function() {
        migrateLocalBookingsToFirebase();
      }, 1000);

      renderTable();
      loadSalesStats(); // Load sales stats for top cards
    }

    function adminLogout() {
      // Clean up Firebase listener
      if (bookingsUnsubscribe) {
        bookingsUnsubscribe();
        bookingsUnsubscribe = null;
      }
      sessionStorage.removeItem('adminAuth');
      location.reload();
    }

    // MAIN TABS
    function switchMainTab(tab, btn) {
      document.querySelectorAll('.admin-tab').forEach(function(t) { t.classList.remove('active'); });
      btn.classList.add('active');

      // Show/hide content
      document.getElementById('productList').classList.remove('active');
      document.getElementById('salesTab').classList.remove('active');
      document.getElementById('bookingsTab').classList.remove('active');
      document.getElementById('discountsTab').classList.remove('active');
      document.getElementById('productSubtabs').style.display = 'none';

      if (tab === 'products') {
        document.getElementById('productSubtabs').style.display = 'flex';
        document.getElementById('productList').classList.add('active');
        renderTable();
      } else if (tab === 'sales') {
        document.getElementById('salesTab').classList.add('active');
        loadPayments();
      } else if (tab === 'bookings') {
        document.getElementById('bookingsTab').classList.add('active');
        renderBookings();
        renderCalendar();
      } else if (tab === 'discounts') {
        document.getElementById('discountsTab').classList.add('active');
        loadDiscounts();
      }
    }

    // PRODUCT SUB-TABS
    function switchSubTab(tab, btn) {
      currentTab = tab;
      document.querySelectorAll('.admin-subtab').forEach(function(t) { t.classList.remove('active'); });
      btn.classList.add('active');
      renderTable();
    }

    // RENDER TABLE
    function renderTable() {
      var products = getProducts();
      var search = document.getElementById('searchInput').value.toLowerCase();
      var tbody = document.getElementById('productTableBody');

      // Filter
      var filtered = products.filter(function(p) {
        var pCols = p.collections || (p.collection ? [p.collection] : []);
        var matchTab = currentTab === 'all' || pCols.indexOf(currentTab) > -1;
        var matchSearch = !search || p.name.toLowerCase().indexOf(search) > -1;
        return matchTab && matchSearch;
      });

      // Sort by sortOrder (lowest first = top of list)
      filtered.sort(function(a, b) {
        var orderA = typeof a.sortOrder === 'number' ? a.sortOrder : 9999;
        var orderB = typeof b.sortOrder === 'number' ? b.sortOrder : 9999;
        return orderA - orderB;
      });

      // Product counts for subtabs
      var countAll = products.length;
      var countNew = products.filter(function(p) { var c = p.collections || (p.collection ? [p.collection] : []); return c.indexOf('new-arrivals') > -1; }).length;
      var countLastChance = products.filter(function(p) { var c = p.collections || (p.collection ? [p.collection] : []); return c.indexOf('last-chance') > -1; }).length;
      var countAccessories = products.filter(function(p) { var c = p.collections || (p.collection ? [p.collection] : []); return c.indexOf('accessories') > -1; }).length;
      var countYetToGoLive = products.filter(function(p) { var c = p.collections || (p.collection ? [p.collection] : []); return c.indexOf('yet-to-go-live') > -1; }).length;

      document.getElementById('countAll').textContent = countAll;
      document.getElementById('countNew').textContent = countNew;
      document.getElementById('countLastChance').textContent = countLastChance;
      document.getElementById('countAccessories').textContent = countAccessories;
      document.getElementById('countYetToGoLive').textContent = countYetToGoLive;

      // Show/hide GO LIVE bar
      document.getElementById('goLiveBar').style.display = currentTab === 'yet-to-go-live' && countYetToGoLive > 0 ? 'flex' : 'none';

      // Table
      tbody.innerHTML = '';
      filtered.forEach(function(p, index) {
        var priceHTML;
        if (p.sale && p.originalPrice) {
          priceHTML = '<span class="was-price">&pound;' + p.originalPrice.toFixed(2) + '</span> &pound;' + p.price.toFixed(2);
        } else {
          priceHTML = '&pound;' + p.price.toFixed(2);
        }

        var pCols = p.collections || (p.collection ? [p.collection] : []);
        var badgeMap = { 'new-arrivals': { cls: 'badge-new', label: "What's New" }, 'last-chance': { cls: 'badge-last-chance', label: 'Last Chance' }, 'accessories': { cls: 'badge-accessories', label: 'Accessories' }, 'yet-to-go-live': { cls: 'badge-yet-live', label: 'Yet to go Live' } };
        var badgesHTML = pCols.map(function(c) { var b = badgeMap[c]; return b ? '<span class="collection-badge ' + b.cls + '">' + b.label + '</span>' : ''; }).join(' ');

        var row = document.createElement('tr');
        row.setAttribute('data-id', p.id);
        row.setAttribute('draggable', 'true');
        row.innerHTML =
          '<td class="reorder-cell">' +
            '<span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>' +
          '</td>' +
          '<td>' +
            (p.image ? '<img src="' + p.image + '" class="product-thumb" alt="" onerror="this.onerror=null;this.src=\'/images/placeholder-product.svg\'">' : '') +
            '<span class="product-name">' + p.name + '</span>' +
          '</td>' +
          '<td>' + priceHTML + '</td>' +
          '<td>' + (p.sizeQuantities ? Object.values(p.sizeQuantities).reduce(function(s,q){return s+(q||0);},0) : (typeof p.quantity === 'number' ? p.quantity : '&mdash;')) + '</td>' +
          '<td>' + badgesHTML + '</td>' +
          '<td>' + (p.sale ? '<span class="status-sale">Sale</span>' : '<span class="status-active">Active</span>') + '</td>' +
          '<td><div class="action-btns">' +
            (currentTab === 'yet-to-go-live' ? '<button class="go-live-btn" onclick="goLiveSingle(\'' + p.id + '\')"><i class="fas fa-rocket"></i> Live</button>' : '') +
            '<button class="edit-btn" onclick="openEditModal(\'' + p.id + '\')">Edit</button>' +
            '<button class="dupe-btn" onclick="duplicateProduct(\'' + p.id + '\')">Dupe</button>' +
            '<button class="delete-btn" onclick="deleteProduct(\'' + p.id + '\')">Delete</button>' +
            '<button class="actions-menu-btn" onclick="openActionMenu(\'' + p.id + '\', \'' + p.name.replace(/'/g, "\\'") + '\')"><i class="fas fa-ellipsis-v"></i></button>' +
          '</div></td>';
        tbody.appendChild(row);
      });
    }

    // Drag and drop reordering
    var draggedRow = null;
    var draggedProductId = null;

    document.addEventListener('dragstart', function(e) {
      if (e.target.tagName === 'TR' && e.target.closest('#productTableBody')) {
        draggedRow = e.target;
        draggedProductId = e.target.getAttribute('data-id');
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      }
    });

    document.addEventListener('dragend', function(e) {
      if (draggedRow) {
        draggedRow.classList.remove('dragging');
        document.querySelectorAll('.drag-over, .drag-over-below').forEach(function(el) {
          el.classList.remove('drag-over', 'drag-over-below');
        });
        draggedRow = null;
        draggedProductId = null;
      }
    });

    document.addEventListener('dragover', function(e) {
      e.preventDefault();
      var row = e.target.closest('tr');
      if (row && row.closest('#productTableBody') && row !== draggedRow) {
        e.dataTransfer.dropEffect = 'move';

        // Clear previous indicators
        document.querySelectorAll('.drag-over, .drag-over-below').forEach(function(el) {
          el.classList.remove('drag-over', 'drag-over-below');
        });

        // Show drop indicator
        var rect = row.getBoundingClientRect();
        var midpoint = rect.top + rect.height / 2;
        if (e.clientY < midpoint) {
          row.classList.add('drag-over');
        } else {
          row.classList.add('drag-over-below');
        }
      }
    });

    document.addEventListener('drop', function(e) {
      e.preventDefault();
      var targetRow = e.target.closest('tr');
      if (!targetRow || !targetRow.closest('#productTableBody') || !draggedProductId) return;

      var targetId = targetRow.getAttribute('data-id');
      if (targetId === draggedProductId) return;

      // Determine if dropping above or below
      var rect = targetRow.getBoundingClientRect();
      var dropBelow = e.clientY > rect.top + rect.height / 2;

      // Reorder products
      var products = getProducts();
      var collection = currentTab === 'all' ? null : currentTab;

      var viewProducts = collection
        ? products.filter(function(p) { var c = p.collections || (p.collection ? [p.collection] : []); return c.indexOf(collection) > -1; })
        : products;

      viewProducts.sort(function(a, b) {
        var orderA = typeof a.sortOrder === 'number' ? a.sortOrder : 9999;
        var orderB = typeof b.sortOrder === 'number' ? b.sortOrder : 9999;
        return orderA - orderB;
      });

      var fromIndex = viewProducts.findIndex(function(p) { return p.id === draggedProductId; });
      var toIndex = viewProducts.findIndex(function(p) { return p.id === targetId; });

      if (fromIndex === -1 || toIndex === -1) return;

      // Adjust target index based on drop position
      if (dropBelow && fromIndex < toIndex) {
        // No adjustment needed
      } else if (dropBelow && fromIndex > toIndex) {
        toIndex++;
      } else if (!dropBelow && fromIndex > toIndex) {
        // No adjustment needed
      } else if (!dropBelow && fromIndex < toIndex) {
        toIndex--;
      }

      // Move item
      var item = viewProducts.splice(fromIndex, 1)[0];
      viewProducts.splice(toIndex, 0, item);

      // Reassign sortOrder
      viewProducts.forEach(function(p, idx) {
        var product = products.find(function(prod) { return prod.id === p.id; });
        if (product) product.sortOrder = idx;
      });

      saveProducts(products);
      renderTable();
    });

    // COLOUR & SIZE MANAGEMENT
    var currentColours = [];
    var CLOTHING_SIZES = [
      { key: 'XS', label: 'XS' }, { key: 'S', label: 'S' }, { key: 'SM', label: 'S/M' },
      { key: 'M', label: 'M' }, { key: 'ML', label: 'M/L' }, { key: 'L', label: 'L' },
      { key: 'XL', label: 'XL' }, { key: 'XXL', label: 'XXL' },
      { key: 'C8', label: '8' }, { key: 'C10', label: '10' }, { key: 'C12', label: '12' },
      { key: 'C14', label: '14' }, { key: 'C16', label: '16' }, { key: 'C18', label: '18' },
      { key: 'FreeSize', label: 'Free Size' }, { key: 'OneSize', label: 'One Size' }
    ];
    // Map input key → display value used in product data
    var SIZE_KEY_TO_VALUE = {};
    CLOTHING_SIZES.forEach(function(s) { SIZE_KEY_TO_VALUE[s.key] = s.label; });

    function toggleColourDropdown() {
      var body = document.getElementById('colourDropdownBody');
      var arrow = document.getElementById('colourDropdownArrow');
      if (body.style.display === 'none') {
        body.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
      } else {
        body.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
      }
    }

    function updateColourBadge() {
      var badge = document.getElementById('colourDropdownBadge');
      if (!badge) return;
      if (currentColours.length > 0) {
        badge.textContent = '(' + currentColours.join(', ') + ')';
      } else {
        badge.textContent = '';
      }
    }

    function renderColourTags() {
      var container = document.getElementById('colourTags');
      if (!container) return;
      container.innerHTML = '';
      currentColours.forEach(function(colour, idx) {
        var tag = document.createElement('span');
        tag.style.cssText = 'display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: #f0ebe4; border: 1px solid #ddd; border-radius: 14px; font-size: 0.75rem; color: #333;';
        var swatch = getColourSwatch(colour);
        tag.innerHTML = '<span style="width: 12px; height: 12px; border-radius: 50%; border: 1px solid #ccc; display: inline-block; background: ' + swatch + ';"></span> ' + colour + ' <button onclick="removeColour(' + idx + ')" style="background: none; border: none; cursor: pointer; color: #999; font-size: 1rem; line-height: 1; padding: 0 2px;">&times;</button>';
        container.appendChild(tag);
      });
      updateColourBadge();
      renderClothingSizes();
    }

    function addColour() {
      var input = document.getElementById('colourInput');
      var val = input.value.trim();
      if (!val) return;
      val.split(',').forEach(function(c) {
        c = c.trim();
        if (c && currentColours.indexOf(c) === -1) currentColours.push(c);
      });
      input.value = '';
      renderColourTags();
    }

    function addPresetColour(colour) {
      if (currentColours.indexOf(colour) === -1) {
        currentColours.push(colour);
        renderColourTags();
      }
    }

    function removeColour(idx) {
      // Save current matrix values before removing
      var saved = readColourSizeMatrix();
      currentColours.splice(idx, 1);
      renderColourTags();
      // Restore remaining colours' values
      loadColourSizeMatrix(saved);
    }

    document.addEventListener('DOMContentLoaded', function() {
      var colourInput = document.getElementById('colourInput');
      if (colourInput) {
        colourInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') { e.preventDefault(); addColour(); }
        });
      }
    });

    function getColourSwatch(name) {
      var map = {
        'Black': '#1a1a1a', 'White': '#ffffff', 'Navy': '#1b2a4a', 'Grey': '#888888',
        'Cream': '#f5f0e6', 'Pink': '#e8a0b4', 'Red': '#c53030', 'Blue': '#2b6cb0',
        'Green': '#2f855a', 'Brown': '#744210', 'Beige': '#d4c5a9', 'Khaki': '#6b6b3d',
        'Chocolate': '#4a2c2a', 'Gold': '#c9a86c', 'Silver': '#b0b0b0',
        'Gunmetal': '#555555', 'Burgundy': '#722f37', 'Teal': '#008080',
        'Coral': '#ff7f50', 'Lilac': '#c8a2c8', 'Nude': '#e3bc9a',
        'Tan': '#d2b48c', 'Charcoal': '#36454f', 'Ivory': '#fffff0',
        'Mustard': '#c8a500', 'Olive': '#556b2f', 'Plum': '#8e4585',
        'Rust': '#b7410e', 'Sand': '#c2b280', 'Stone': '#928e85',
        'Taupe': '#483c32', 'Wine': '#722f37', 'Camel': '#c19a6b'
      };
      return map[name] || '#ddd';
    }

    // Render clothing sizes — flat grid (no colours) or colour-size matrix
    function renderClothingSizes() {
      var container = document.getElementById('clothingSizesContainer');
      if (!container) return;

      if (currentColours.length === 0) {
        // FLAT GRID — no colours
        var html = '<div class="size-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;">';
        CLOTHING_SIZES.forEach(function(s) {
          html += '<div class="size-cell" style="display: flex; align-items: center; gap: 6px; background: #fafafa; border: 1px solid #eee; padding: 8px 10px; border-radius: 4px;">' +
            '<span style="font-size: 0.8rem; color: #555; min-width: 55px;">' + s.label + '</span>' +
            '<input type="number" class="form-input" id="sizeQty' + s.key + '" placeholder="0" min="0" step="1" style="width: 60px; padding: 6px 8px; text-align: center; font-size: 0.85rem;">' +
          '</div>';
        });
        html += '</div>';
        container.innerHTML = html;
      } else {
        // COLOUR-SIZE MATRIX — sizes as rows, colours as columns (fits without horizontal scroll)
        var html = '<div style="margin-top: 8px;"><table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">';
        // Header row — colour labels
        html += '<thead><tr><th style="padding: 6px 8px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600; color: #555; width: 60px;">Size</th>';
        currentColours.forEach(function(colour) {
          var swatch = getColourSwatch(colour);
          html += '<th style="padding: 6px 4px; text-align: center; border-bottom: 2px solid #ddd; font-weight: 600; color: #555;">' +
            '<span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: ' + swatch + '; border: 1px solid #ccc; vertical-align: middle; margin-right: 3px;"></span>' + colour + '</th>';
        });
        html += '</tr></thead><tbody>';
        // One row per size
        CLOTHING_SIZES.forEach(function(s) {
          html += '<tr style="border-bottom: 1px solid #eee;">';
          html += '<td style="padding: 5px 8px; font-weight: 500; color: #555;">' + s.label + '</td>';
          currentColours.forEach(function(colour) {
            var inputId = 'csq_' + colour.replace(/[^a-zA-Z0-9]/g, '_') + '_' + s.key;
            html += '<td style="padding: 3px 2px; text-align: center;">' +
              '<input type="number" id="' + inputId + '" placeholder="0" min="0" step="1" ' +
              'style="width: 100%; max-width: 60px; padding: 4px 2px; text-align: center; font-size: 0.8rem; border: 1px solid #eee; border-radius: 3px;">' +
            '</td>';
          });
          html += '</tr>';
        });
        html += '</tbody></table></div>';
        container.innerHTML = html;
      }
    }

    // Read colour-size matrix inputs → { "Black": { "S": 3, "M": 5 }, "Navy": { "L": 4 } }
    function readColourSizeMatrix() {
      var result = {};
      currentColours.forEach(function(colour) {
        var colourData = {};
        CLOTHING_SIZES.forEach(function(s) {
          var inputId = 'csq_' + colour.replace(/[^a-zA-Z0-9]/g, '_') + '_' + s.key;
          var input = document.getElementById(inputId);
          if (input) {
            var val = parseInt(input.value, 10);
            if (val > 0) colourData[SIZE_KEY_TO_VALUE[s.key]] = val;
          }
        });
        if (Object.keys(colourData).length > 0) result[colour] = colourData;
      });
      return result;
    }

    // Load colour-size matrix from data → set input values
    function loadColourSizeMatrix(data) {
      if (!data) return;
      currentColours.forEach(function(colour) {
        var colourData = data[colour] || {};
        CLOTHING_SIZES.forEach(function(s) {
          var inputId = 'csq_' + colour.replace(/[^a-zA-Z0-9]/g, '_') + '_' + s.key;
          var input = document.getElementById(inputId);
          var sizeValue = SIZE_KEY_TO_VALUE[s.key];
          if (input) {
            input.value = colourData[sizeValue] > 0 ? colourData[sizeValue] : '';
          }
        });
      });
    }

    // Read flat grid inputs → { sizeQuantities, sizes }
    function readFlatSizeGrid() {
      var sizeQuantities = {};
      var sizes = [];
      CLOTHING_SIZES.forEach(function(s) {
        var input = document.getElementById('sizeQty' + s.key);
        if (!input) return;
        var val = parseInt(input.value, 10);
        var sizeValue = SIZE_KEY_TO_VALUE[s.key];
        if (val > 0) {
          sizeQuantities[sizeValue] = val;
          sizes.push(sizeValue);
        }
      });
      return { sizeQuantities: sizeQuantities, sizes: sizes };
    }

    // Load flat grid from data
    function loadFlatSizeGrid(sizeQuantities) {
      if (!sizeQuantities) return;
      CLOTHING_SIZES.forEach(function(s) {
        var input = document.getElementById('sizeQty' + s.key);
        var sizeValue = SIZE_KEY_TO_VALUE[s.key];
        if (input) {
          input.value = sizeQuantities[sizeValue] > 0 ? sizeQuantities[sizeValue] : '';
        }
      });
    }

    // Derive aggregated sizeQuantities from colourSizeQuantities (for listing page stock checks)
    function aggregateColourSizes(csq) {
      var result = {};
      Object.keys(csq).forEach(function(colour) {
        Object.keys(csq[colour]).forEach(function(size) {
          result[size] = (result[size] || 0) + csq[colour][size];
        });
      });
      return result;
    }

    // BULK SIZES
    var BULK_SIZES = ['XS','S','S/M','M','M/L','L','XL','XXL','8','10','12','14','16','18','One Size'];

    function openBulkSizes() {
      var products = getProducts();
      var html = '<table class="bulk-table"><thead><tr><th>Product</th>';
      BULK_SIZES.forEach(function(s) { html += '<th>' + s + '</th>'; });
      html += '<th>Status</th></tr></thead><tbody>';

      products.forEach(function(p, idx) {
        // Get current sizes from any source
        var sq = {};
        if (p.colourSizeQuantities) {
          sq = aggregateColourSizes(p.colourSizeQuantities);
        } else if (p.sizeQuantities) {
          sq = p.sizeQuantities;
        }
        var hasSizes = Object.keys(sq).some(function(k) { return k !== 'One Size' && k !== 'Free Size'; }) || (sq['One Size'] > 0 || sq['Free Size'] > 0);
        var hasColourMatrix = p.colourSizeQuantities && Object.keys(p.colourSizeQuantities).length > 0;

        html += '<tr data-product-idx="' + idx + '">';
        html += '<td>' + p.name + (hasColourMatrix ? ' <span style="font-size:0.6rem;color:#888;">(has colours)</span>' : '') + '</td>';
        BULK_SIZES.forEach(function(s) {
          var val = sq[s] || '';
          // If product has colour matrix, show aggregated values as read-only
          if (hasColourMatrix) {
            html += '<td><input type="number" min="0" step="1" value="' + (val || '') + '" data-size="' + s + '" disabled style="background:#f0f0f0;color:#999;" title="Edit via product colour matrix"></td>';
          } else {
            html += '<td><input type="number" min="0" step="1" value="' + (val || '') + '" data-size="' + s + '"></td>';
          }
        });
        html += '<td>' + (hasSizes ? '<span class="bulk-has-sizes"><i class="fas fa-check"></i></span>' : '<span class="bulk-no-sizes"><i class="fas fa-times"></i> No sizes</span>') + '</td>';
        html += '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById('bulkSizesTableWrap').innerHTML = html;
      document.getElementById('bulkSizesOverlay').classList.add('show');
    }

    function closeBulkSizes() {
      document.getElementById('bulkSizesOverlay').classList.remove('show');
    }

    function saveBulkSizes() {
      var products = getProducts();
      var rows = document.querySelectorAll('#bulkSizesTableWrap tr[data-product-idx]');
      var changed = false;

      rows.forEach(function(row) {
        var idx = parseInt(row.getAttribute('data-product-idx'), 10);
        var p = products[idx];
        if (!p) return;

        // Skip products with colour matrix (edit those individually)
        if (p.colourSizeQuantities && Object.keys(p.colourSizeQuantities).length > 0) return;

        var newSQ = {};
        var newSizes = [];
        var inputs = row.querySelectorAll('input[data-size]:not([disabled])');
        inputs.forEach(function(input) {
          var size = input.getAttribute('data-size');
          var val = parseInt(input.value, 10);
          if (val > 0) {
            newSQ[size] = val;
            newSizes.push(size);
          }
        });

        // Check if anything changed
        var oldSQ = p.sizeQuantities || {};
        var same = JSON.stringify(newSQ) === JSON.stringify(oldSQ);
        if (!same) {
          p.sizeQuantities = newSQ;
          p.sizes = newSizes;
          // Update total quantity
          p.quantity = Object.values(newSQ).reduce(function(s,q){return s+(q||0);},0);
          changed = true;
        }
      });

      if (changed) {
        saveProducts(products);
        renderTable();
        closeBulkSizes();
        alert('Sizes updated for all products!');
      } else {
        closeBulkSizes();
        alert('No changes detected.');
      }
    }

    // MODAL
    function openAddModal() {
      editingId = null;
      currentImages = [];
      document.getElementById('modalTitle').textContent = 'Add Product';
      document.getElementById('formName').value = '';
      document.getElementById('formImage').value = '';
      document.getElementById('colNewArrivals').checked = false;
      document.getElementById('colLastChance').checked = false;
      document.getElementById('colAccessories').checked = false;
      document.getElementById('formYetToGoLive').checked = false;
      document.getElementById('formPrice').value = '';
      document.getElementById('formDescription').value = '';
      document.getElementById('formSale').checked = false;
      document.getElementById('formOriginalPrice').value = '';
      document.getElementById('formSalePrice').value = '';
      document.getElementById('saleFields').classList.remove('show');
      document.getElementById('urlInputWrap').style.display = 'none';
      document.getElementById('fileInput').value = '';
      renderImageGrid();
      // Hide notify banner for new products
      document.getElementById('notifyBanner').style.display = 'none';
      // Clear colours and collapse dropdown
      currentColours = [];
      document.getElementById('colourInput').value = '';
      document.getElementById('colourDropdownBody').style.display = 'none';
      document.getElementById('colourDropdownArrow').style.transform = 'rotate(0deg)';
      renderColourTags();
      // Clear shoe size inputs
      [3,4,5,6,7,8].forEach(function(s) {
        document.getElementById('sizeQtyShoe' + s).value = '';
      });
      document.getElementById('modalOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function openEditModal(id) {
      var products = getProducts();
      var p = products.find(function(x) { return x.id === id; });
      if (!p) return;

      editingId = id;
      // Load images array (backward compat: single image -> array)
      currentImages = p.images ? p.images.slice() : (p.image ? [p.image] : []);
      document.getElementById('modalTitle').textContent = 'Edit Product';
      document.getElementById('formName').value = p.name;
      document.getElementById('formImage').value = '';
      var cols = p.collections || (p.collection ? [p.collection] : ['new-arrivals']);
      document.getElementById('colNewArrivals').checked = cols.indexOf('new-arrivals') > -1;
      document.getElementById('colLastChance').checked = cols.indexOf('last-chance') > -1;
      document.getElementById('colAccessories').checked = cols.indexOf('accessories') > -1;
      document.getElementById('formYetToGoLive').checked = cols.indexOf('yet-to-go-live') > -1;
      document.getElementById('formPrice').value = p.price;
      document.getElementById('formDescription').value = p.description || '';
      document.getElementById('formSale').checked = p.sale;
      document.getElementById('urlInputWrap').style.display = 'none';
      document.getElementById('fileInput').value = '';
      renderImageGrid();

      // Load colours and render size grid/matrix
      currentColours = (p.colours && Array.isArray(p.colours)) ? p.colours.slice() : [];
      document.getElementById('colourInput').value = '';
      // Auto-open dropdown if product has colours, collapse otherwise
      if (currentColours.length > 0) {
        document.getElementById('colourDropdownBody').style.display = 'block';
        document.getElementById('colourDropdownArrow').style.transform = 'rotate(180deg)';
      } else {
        document.getElementById('colourDropdownBody').style.display = 'none';
        document.getElementById('colourDropdownArrow').style.transform = 'rotate(0deg)';
      }
      renderColourTags();

      // Load clothing size data into the rendered grid
      if (currentColours.length > 0 && p.colourSizeQuantities) {
        // Load colour-size matrix
        loadColourSizeMatrix(p.colourSizeQuantities);
      } else {
        // Load flat grid (backward compat)
        var sq = p.sizeQuantities || {};
        if (!p.sizeQuantities && p.sizes) {
          var perSize = p.sizes.length > 0 && typeof p.quantity === 'number' ? Math.floor(p.quantity / p.sizes.length) : 0;
          p.sizes.forEach(function(s) { sq[s] = perSize; });
        }
        loadFlatSizeGrid(sq);
      }
      // Load shoe sizes
      var shoeQty = p.sizeQuantities || {};
      [3,4,5,6,7,8].forEach(function(s) {
        var input = document.getElementById('sizeQtyShoe' + s);
        input.value = shoeQty[String(s)] > 0 ? shoeQty[String(s)] : '';
      });

      if (p.sale && p.originalPrice) {
        document.getElementById('formOriginalPrice').value = p.originalPrice;
        document.getElementById('formSalePrice').value = p.price;
        document.getElementById('saleFields').classList.add('show');
      } else {
        document.getElementById('formOriginalPrice').value = '';
        document.getElementById('formSalePrice').value = '';
        document.getElementById('saleFields').classList.remove('show');
      }

      // Load pending stock notifications for this product
      loadNotifyBanner(id);

      document.getElementById('modalOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('show');
      document.body.style.overflow = '';
      editingId = null;
    }

    // --- Stock notification helpers ---
    var _pendingNotifyDocs = []; // Cache for current product's notifications

    function loadNotifyBanner(productId) {
      var banner = document.getElementById('notifyBanner');
      var countEl = document.getElementById('notifyBannerCount');
      var emailsEl = document.getElementById('notifyBannerEmails');
      _pendingNotifyDocs = [];
      banner.style.display = 'none';

      if (typeof db === 'undefined') return;

      db.collection('stockNotifications')
        .where('productId', '==', productId)
        .where('notified', '==', false)
        .get()
        .then(function(snapshot) {
          if (snapshot.empty) return;
          snapshot.forEach(function(doc) {
            _pendingNotifyDocs.push({ id: doc.id, ...doc.data() });
          });
          var count = _pendingNotifyDocs.length;
          countEl.textContent = count + (count === 1 ? ' person' : ' people');
          emailsEl.textContent = _pendingNotifyDocs.map(function(d) { return d.email; }).join(', ');
          banner.style.display = 'block';
        })
        .catch(function(err) {
          console.error('Error loading notifications:', err);
        });
    }

    function copyNotifyEmails() {
      var emails = _pendingNotifyDocs.map(function(d) { return d.email; }).join(', ');
      navigator.clipboard.writeText(emails).then(function() {
        showAlert('Copied!', emails);
      }).catch(function() {
        prompt('Copy these emails:', emails);
      });
    }

    function markNotificationsAsSent(productId) {
      if (_pendingNotifyDocs.length === 0) return Promise.resolve();
      var batch = db.batch();
      _pendingNotifyDocs.forEach(function(doc) {
        batch.update(db.collection('stockNotifications').doc(doc.id), {
          notified: true,
          notifiedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      return batch.commit().then(function() {
        _pendingNotifyDocs = [];
      });
    }

    function toggleSaleFields() {
      var checked = document.getElementById('formSale').checked;
      document.getElementById('saleFields').classList.toggle('show', checked);
    }

    // ============================================
    // MULTI-IMAGE SUPPORT
    // ============================================
    var currentImages = []; // Array of image data URLs or external URLs

    function renderImageGrid() {
      var grid = document.getElementById('multiImageGrid');
      grid.innerHTML = '';
      currentImages.forEach(function(src, index) {
        var item = document.createElement('div');
        item.className = 'multi-image-item' + (index === 0 ? ' primary' : '');
        item.innerHTML =
          '<img src="' + src + '" alt="Image ' + (index + 1) + '" onclick="event.stopPropagation(); openLightbox(this.src);">' +
          '<button type="button" class="remove-img-btn" onclick="event.stopPropagation(); removeImageAt(' + index + ');">&times;</button>' +
          (index === 0 ? '<div class="primary-label">Main</div>' : '');
        item.setAttribute('draggable', 'true');
        item.ondragstart = function(e) { e.dataTransfer.setData('text/plain', index); e.dataTransfer.effectAllowed = 'move'; };
        item.ondragover = function(e) { e.preventDefault(); };
        item.ondrop = function(e) {
          e.preventDefault(); e.stopPropagation();
          var fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
          if (fromIdx !== index) {
            var moved = currentImages.splice(fromIdx, 1)[0];
            currentImages.splice(index, 0, moved);
            renderImageGrid();
          }
        };
        grid.appendChild(item);
      });
      // Show/hide the upload area placeholder text
      document.getElementById('uploadPlaceholder').querySelector('p').textContent =
        currentImages.length > 0 ? 'Add another image' : 'Click to upload or drag & drop';
    }

    function removeImageAt(index) {
      currentImages.splice(index, 1);
      renderImageGrid();
    }

    function handleFileUpload(input) {
      if (!input.files || !input.files.length) return;
      for (var i = 0; i < input.files.length; i++) {
        processFile(input.files[i]);
      }
      input.value = '';
    }

    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
      if (e.dataTransfer.files && e.dataTransfer.files.length) {
        for (var i = 0; i < e.dataTransfer.files.length; i++) {
          processFile(e.dataTransfer.files[i]);
        }
      }
    }

    function processFile(file) {
      if (!file.type.startsWith('image/')) { showToast('Please upload an image file', 'error'); return; }
      if (file.size > 20 * 1024 * 1024) { showToast('Image must be under 20MB', 'error'); return; }

      var reader = new FileReader();
      reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
          var maxSize = 2400;
          var w = img.width, h = img.height;
          var needsResize = w > maxSize || h > maxSize;

          if (!needsResize && file.type === 'image/jpeg') {
            // Already within bounds and JPEG — upload original file to preserve full quality
            uploadImageToR2(file).then(function(url) {
              if (url) { currentImages.push(url); renderImageGrid(); }
            });
            return;
          }

          if (needsResize) {
            if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
            else { w = Math.round(w * maxSize / h); h = maxSize; }
          }
          var canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          // Upload to R2 for high quality storage
          canvas.toBlob(function(blob) {
            uploadImageToR2(blob).then(function(url) {
              if (url) {
                currentImages.push(url);
                renderImageGrid();
              }
            });
          }, 'image/jpeg', 0.95);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    async function uploadImageToR2(blob) {
      try {
        showToast('Uploading image...', 'info');
        var formData = new FormData();
        formData.append('file', blob, Date.now() + '.jpg');
        formData.append('adminPass', 'admin123');

        var response = await fetch('/api/upload-image', {
          method: 'POST',
          body: formData
        });

        var data = await response.json();
        if (data.error) {
          showToast('Upload failed: ' + data.error, 'error');
          return null;
        }

        showToast('Image uploaded!', 'success');
        return data.url;
      } catch (error) {
        showToast('Upload error: ' + error.message, 'error');
        return null;
      }
    }

    function toggleUrlInput() {
      var wrap = document.getElementById('urlInputWrap');
      wrap.style.display = wrap.style.display === 'none' ? 'block' : 'none';
    }

    function addUrlImage() {
      var url = document.getElementById('formImage').value.trim();
      if (url) {
        currentImages.push(url);
        renderImageGrid();
        document.getElementById('formImage').value = '';
      }
    }

    // ============================================
    // TOAST NOTIFICATION
    // ============================================
    var toastTimer = null;
    function showToast(message, type) {
      var toast = document.getElementById('adminToast');
      toast.innerHTML = (type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-check-circle"></i>') + ' ' + message;
      toast.style.background = type === 'error' ? '#c53030' : '#333';
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(function() { toast.classList.remove('show'); }, 2500);
    }

    // ============================================
    // APPLE-STYLE CONFIRMATION DIALOG
    // ============================================
    var confirmCallback = null;
    var confirmIsAlert = false;
    function showConfirm(title, message, actionLabel, callback, isDestructive) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      var btn = document.getElementById('confirmAction');
      btn.textContent = actionLabel;
      btn.className = 'confirm-btn ' + (isDestructive ? 'destructive' : 'primary');
      confirmCallback = callback;
      confirmIsAlert = false;
      document.getElementById('confirmCancel').style.display = '';
      document.getElementById('confirmOverlay').classList.add('show');
    }
    function showAlert(title, message) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      var btn = document.getElementById('confirmAction');
      btn.textContent = 'OK';
      btn.className = 'confirm-btn primary';
      confirmCallback = null;
      confirmIsAlert = true;
      document.getElementById('confirmCancel').style.display = 'none';
      document.getElementById('confirmOverlay').classList.add('show');
    }
    function executeConfirm() {
      document.getElementById('confirmOverlay').classList.remove('show');
      if (confirmCallback) { confirmCallback(); confirmCallback = null; }
    }
    function cancelConfirm() {
      document.getElementById('confirmOverlay').classList.remove('show');
      confirmCallback = null;
    }

    function openLightbox(src) {
      if (!src) return;
      document.getElementById('lightboxImg').src = src;
      document.getElementById('imageLightbox').classList.add('show');
    }

    function closeLightbox() {
      document.getElementById('imageLightbox').classList.remove('show');
      document.getElementById('lightboxImg').src = '';
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('imageLightbox').classList.contains('show')) {
        closeLightbox();
      }
    });

    // SAVE
    function saveProduct() {
      var name = document.getElementById('formName').value.trim();
      var images = currentImages.slice();
      var image = images.length > 0 ? images[0] : '';
      var collections = [];
      if (document.getElementById('colNewArrivals').checked) collections.push('new-arrivals');
      if (document.getElementById('colLastChance').checked) collections.push('last-chance');
      if (document.getElementById('colAccessories').checked) collections.push('accessories');
      if (collections.length === 0) { showAlert('Missing Collection', 'Please select at least one collection'); return; }

      // Yet to go Live toggle
      if (document.getElementById('formYetToGoLive').checked) {
        collections.push('yet-to-go-live');
      }
      var description = document.getElementById('formDescription').value.trim();
      var isSale = document.getElementById('formSale').checked;
      var price, originalPrice;

      // Gather size/colour data
      var colourSizeQuantities = null;
      var sizeQuantities = {};
      var sizes = [];

      if (currentColours.length > 0) {
        // COLOUR-SIZE MATRIX MODE
        colourSizeQuantities = readColourSizeMatrix();
        // Derive aggregated sizeQuantities for backward compat (listing pages, stock checks)
        sizeQuantities = aggregateColourSizes(colourSizeQuantities);
        sizes = Object.keys(sizeQuantities);
        // Sort sizes in canonical order
        var sizeOrder = ['XS', 'S', 'S/M', 'M', 'M/L', 'L', 'XL', 'XXL', '8', '10', '12', '14', '16', '18', 'Free Size', 'One Size'];
        sizes.sort(function(a, b) {
          var ia = sizeOrder.indexOf(a), ib = sizeOrder.indexOf(b);
          return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
        });
      } else {
        // FLAT GRID MODE (no colours)
        var flatData = readFlatSizeGrid();
        sizeQuantities = flatData.sizeQuantities;
        sizes = flatData.sizes;
      }

      // Add shoe sizes (always separate)
      [3,4,5,6,7,8].forEach(function(s) {
        var input = document.getElementById('sizeQtyShoe' + s);
        var val = parseInt(input.value, 10);
        if (val > 0) {
          sizeQuantities[String(s)] = val;
          sizes.push(String(s));
        }
      });

      // Total quantity = sum of all size quantities
      var quantity = Object.values(sizeQuantities).reduce(function(sum, q) { return sum + q; }, 0) || null;

      if (!name) { showAlert('Missing Name', 'Please enter a product name'); return; }
      if (!description) { showAlert('Missing Description', 'Please enter a product description'); return; }

      if (isSale) {
        originalPrice = parseFloat(document.getElementById('formOriginalPrice').value);
        price = parseFloat(document.getElementById('formSalePrice').value);
        if (isNaN(originalPrice) || isNaN(price)) { showAlert('Missing Prices', 'Please enter both original and sale prices'); return; }
      } else {
        price = parseFloat(document.getElementById('formPrice').value);
        originalPrice = null;
        if (isNaN(price)) { showAlert('Missing Price', 'Please enter a price'); return; }
      }

      var products = getProducts();

      if (editingId) {
        // Edit existing
        var idx = products.findIndex(function(p) { return p.id === editingId; });
        if (idx > -1) {
          products[idx].name = name;
          products[idx].image = image;
          products[idx].images = images;
          products[idx].collections = collections;
          delete products[idx].collection;
          products[idx].price = price;
          products[idx].sale = isSale;
          products[idx].originalPrice = originalPrice;
          products[idx].description = description;
          products[idx].sizes = sizes;
          products[idx].quantity = quantity;
          products[idx].sizeQuantities = sizeQuantities;
          products[idx].colours = currentColours.slice();
          products[idx].colourSizeQuantities = colourSizeQuantities;
        }
      } else {
        // Add new - find lowest sortOrder among products in any of the selected collections
        var sameCollection = products.filter(function(p) {
          var pCols = p.collections || (p.collection ? [p.collection] : []);
          return collections.some(function(c) { return pCols.indexOf(c) > -1; });
        });
        var minOrder = 0;
        sameCollection.forEach(function(p) {
          if (typeof p.sortOrder === 'number' && p.sortOrder <= minOrder) {
            minOrder = p.sortOrder - 1;
          }
        });

        var id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/, '') + '-' + Date.now();
        products.push({
          id: id,
          name: name,
          price: price,
          image: image,
          images: images,
          collections: collections,
          sale: isSale,
          originalPrice: originalPrice,
          description: description,
          sizes: sizes,
          quantity: quantity,
          sizeQuantities: sizeQuantities,
          colours: currentColours.slice(),
          colourSizeQuantities: colourSizeQuantities,
          sortOrder: minOrder
        });
      }

      saveProducts(products);

      // Check if we should notify subscribers (stock went from 0 to >0)
      if (editingId && _pendingNotifyDocs.length > 0 && quantity > 0) {
        var emailList = _pendingNotifyDocs.map(function(d) { return d.email; }).join(', ');
        var count = _pendingNotifyDocs.length;
        showConfirm(
          'Back in Stock — ' + count + ' waiting',
          count + ' customer' + (count > 1 ? 's' : '') + ' asked to be notified:\n\n' + emailList + '\n\nMark them as notified?',
          'Yes, Mark Notified',
          function() {
            markNotificationsAsSent(editingId);
            navigator.clipboard.writeText(emailList).catch(function() {});
          }
        );
      }

      closeModal();
      renderTable();
    }

    // DELETE
    function deleteProduct(id) {
      showConfirm('Delete Product', 'Are you sure you want to delete this product?', 'Delete', function() {
        var products = getProducts().filter(function(p) { return p.id !== id; });
        saveProducts(products);
        renderTable();
      }, true);
    }

    // Go Live - remove yet-to-go-live flag (products already have their target categories)
    var goLiveProductIds = []; // empty = all yet-to-go-live

    function goLive() {
      goLiveProductIds = [];
      pushLive();
    }

    function goLiveSingle(id) {
      goLiveProductIds = [id];
      pushLive();
    }

    function pushLive() {
      var isSingle = goLiveProductIds.length === 1;
      var title = isSingle ? 'Push Product Live' : 'Push All Products Live';
      var collectionLabels = { 'new-arrivals': "What's New", 'last-chance': 'Last Chance', 'accessories': 'Accessories' };

      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').innerHTML =
        '<div style="color:#666; font-size:0.78rem;">' +
          (isSingle ? 'This product' : 'These products') + ' will become visible to customers in ' +
          (isSingle ? 'its' : 'their') + ' assigned categories.' +
        '</div>';

      var btn = document.getElementById('confirmAction');
      btn.textContent = 'Push Live';
      btn.className = 'confirm-btn primary';
      confirmCallback = function() {
        var products = getProducts();
        var moved = 0;
        products.forEach(function(p) {
          var cols = p.collections || (p.collection ? [p.collection] : []);
          var idx = cols.indexOf('yet-to-go-live');
          if (idx === -1) return;
          if (goLiveProductIds.length > 0 && goLiveProductIds.indexOf(p.id) === -1) return;
          cols.splice(idx, 1);
          p.collections = cols;
          delete p.collection;
          moved++;
        });
        if (moved > 0) {
          saveProducts(products);
          renderTable();
          var catNames = [];
          products.forEach(function(p) {
            if (goLiveProductIds.length > 0 && goLiveProductIds.indexOf(p.id) === -1) return;
            (p.collections || []).forEach(function(c) {
              if (collectionLabels[c] && catNames.indexOf(collectionLabels[c]) === -1) catNames.push(collectionLabels[c]);
            });
          });
          showToast(moved + ' product' + (moved !== 1 ? 's' : '') + ' now live' + (catNames.length ? ' in ' + catNames.join(', ') : ''));
        }
      };
      document.getElementById('confirmOverlay').classList.add('show');
    }

    function duplicateProduct(id) {
      var products = getProducts();
      var original = products.find(function(p) { return p.id === id; });
      if (!original) return;
      var copy = JSON.parse(JSON.stringify(original));
      copy.id = Date.now().toString();
      copy.name = original.name + ' (Copy)';
      // Place copy right after original with same sortOrder + 0.5
      copy.sortOrder = (typeof original.sortOrder === 'number' ? original.sortOrder : 9999) + 0.5;
      products.push(copy);
      saveProducts(products);
      // Expand the table so the duplicate is visible
      var container = document.getElementById('tableContainer');
      container.classList.remove('collapsed');
      var btn = document.getElementById('showMoreBtn');
      btn.innerHTML = 'Show Less <i class="fas fa-chevron-down"></i>';
      renderTable();
      // Scroll to the duplicated row and highlight it
      setTimeout(function() {
        var newRow = document.querySelector('tr[data-id="' + copy.id + '"]');
        if (newRow) {
          newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
          newRow.style.background = '#e3f2fd';
          setTimeout(function() { newRow.style.transition = 'background 1s'; newRow.style.background = ''; }, 1500);
        }
      }, 100);
      showToast('Product duplicated successfully');
    }

    // Mobile action menu
    var actionMenuProductId = null;

    function openActionMenu(id, name) {
      actionMenuProductId = id;
      document.getElementById('actionPopupTitle').textContent = name;
      // Show/hide Go Live vs Move Up/Down based on tab
      var goLiveItem = document.getElementById('actionMenuGoLiveItem');
      var moveUpItem = document.getElementById('actionMenuMoveUpItem');
      var moveDownItem = document.getElementById('actionMenuMoveDownItem');
      if (currentTab === 'yet-to-go-live') {
        goLiveItem.style.display = '';
        moveUpItem.style.display = 'none';
        moveDownItem.style.display = 'none';
      } else {
        goLiveItem.style.display = 'none';
        moveUpItem.style.display = '';
        moveDownItem.style.display = '';
      }
      document.getElementById('actionPopup').classList.add('show');
    }

    function closeActionMenu() {
      document.getElementById('actionPopup').classList.remove('show');
      actionMenuProductId = null;
    }

    function actionMenuEdit() {
      var id = actionMenuProductId;
      closeActionMenu();
      openEditModal(id);
    }

    function actionMenuDupe() {
      var id = actionMenuProductId;
      closeActionMenu();
      duplicateProduct(id);
    }

    function actionMenuDelete() {
      var id = actionMenuProductId;
      closeActionMenu();
      deleteProduct(id);
    }

    function moveProduct(id, direction) {
      var products = getProducts();
      var collection = currentTab === 'all' ? null : currentTab;
      var viewProducts = collection
        ? products.filter(function(p) { var c = p.collections || (p.collection ? [p.collection] : []); return c.indexOf(collection) > -1; })
        : products;
      viewProducts.sort(function(a, b) {
        var oa = typeof a.sortOrder === 'number' ? a.sortOrder : 9999;
        var ob = typeof b.sortOrder === 'number' ? b.sortOrder : 9999;
        return oa - ob;
      });
      var idx = viewProducts.findIndex(function(p) { return p.id === id; });
      if (idx === -1) return;
      var swapIdx = idx + direction;
      if (swapIdx < 0 || swapIdx >= viewProducts.length) return;
      var temp = viewProducts[idx];
      viewProducts[idx] = viewProducts[swapIdx];
      viewProducts[swapIdx] = temp;
      viewProducts.forEach(function(p, i) {
        var prod = products.find(function(pr) { return pr.id === p.id; });
        if (prod) prod.sortOrder = i;
      });
      saveProducts(products);
      renderTable();
    }

    function actionMenuMoveUp() {
      var id = actionMenuProductId;
      closeActionMenu();
      moveProduct(id, -1);
    }

    function actionMenuMoveDown() {
      var id = actionMenuProductId;
      closeActionMenu();
      moveProduct(id, 1);
    }

    function actionMenuGoLive() {
      var id = actionMenuProductId;
      closeActionMenu();
      goLiveSingle(id);
    }

    // BOOKINGS
    var currentCalendarDate = new Date();
    var selectedCalendarDate = null;
    var AVAILABLE_DAYS = [1, 3, 5]; // Mon, Wed, Fri
    var TIME_SLOTS = [
      { time: '10:00', label: '10:00 – 11:00' },
      { time: '11:00', label: '11:00 – 12:00' },
      { time: '12:00', label: '12:00 – 13:00' },
      { time: '13:00', label: '13:00 – 14:00' }
    ];

    // getBookings() is defined above (line 812) - uses Firebase bookingsCache

    function formatBookingDate(dateStr) {
      var d = new Date(dateStr);
      var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return days[d.getDay()] + ', ' + d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
    }

    function formatShortDate(dateStr) {
      var d = new Date(dateStr);
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return d.getDate() + ' ' + months[d.getMonth()];
    }

    function formatTime(time) {
      var labels = { "10:00": "10am", "11:00": "11am", "12:00": "12pm", "13:00": "1pm" };
      return labels[time] || time;
    }

    function formatPhoneForWhatsApp(phone) {
      var cleaned = phone.replace(/[\s\-\(\)]/g, '');
      if (cleaned.startsWith('0')) {
        cleaned = '44' + cleaned.substring(1);
      }
      if (cleaned.startsWith('+')) {
        cleaned = cleaned.substring(1);
      }
      return cleaned;
    }

    function getBookingsForDate(date) {
      var bookings = getBookings();
      return bookings.filter(function(b) {
        var bDate = new Date(b.booking.date);
        return bDate.toDateString() === date.toDateString() && b.status !== 'cancelled';
      });
    }

    function isAvailableDay(date) {
      return AVAILABLE_DAYS.indexOf(date.getDay()) > -1;
    }

    // Summary calculations
    function updateSummary() {
      var bookings = getBookings().filter(function(b) { return b.status !== 'cancelled'; });
      var today = new Date();
      today.setHours(0, 0, 0, 0);

      // Today's bookings
      var todayBookings = bookings.filter(function(b) {
        var bDate = new Date(b.booking.date);
        bDate.setHours(0, 0, 0, 0);
        return bDate.getTime() === today.getTime();
      });
      document.getElementById('summaryToday').textContent = todayBookings.length;

      // This week's bookings (Mon-Sun)
      var startOfWeek = new Date(today);
      var dayOfWeek = today.getDay() || 7;
      startOfWeek.setDate(today.getDate() - dayOfWeek + 1);
      var endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);

      var weekBookings = bookings.filter(function(b) {
        var bDate = new Date(b.booking.date);
        bDate.setHours(0, 0, 0, 0);
        return bDate >= startOfWeek && bDate <= endOfWeek;
      });
      document.getElementById('summaryWeek').textContent = weekBookings.length + ' / ' + (AVAILABLE_DAYS.length * TIME_SLOTS.length);

      // Next booking
      var futureBookings = bookings.filter(function(b) {
        var bDate = new Date(b.booking.date);
        return bDate >= today;
      }).sort(function(a, b) {
        return new Date(a.booking.date) - new Date(b.booking.date);
      });

      if (futureBookings.length > 0) {
        var next = futureBookings[0];
        var customerName = (next.customer && next.customer.name) ? next.customer.name : 'Booking';
        document.getElementById('summaryNext').textContent = formatShortDate(next.booking.date);
        document.getElementById('summaryNextTime').textContent = formatTime(next.booking.time) + ' - ' + customerName;
      } else {
        document.getElementById('summaryNext').textContent = 'None';
        document.getElementById('summaryNextTime').textContent = '';
      }
    }

    function renderBookings() {
      var bookings = getBookings();
      var list = document.getElementById('bookingsList');

      updateSummary();

      // Sort by date, upcoming first, then past
      var now = new Date();
      bookings.sort(function(a, b) {
        var dateA = new Date(a.booking.date);
        var dateB = new Date(b.booking.date);
        var aFuture = dateA >= now;
        var bFuture = dateB >= now;
        if (aFuture && !bFuture) return -1;
        if (!aFuture && bFuture) return 1;
        if (aFuture) return dateA - dateB;
        return dateB - dateA;
      });

      if (bookings.length === 0) {
        list.innerHTML =
          '<div class="no-bookings">' +
            '<div class="no-bookings-icon"><i class="fas fa-calendar-alt"></i></div>' +
            '<div class="no-bookings-title">No bookings yet</div>' +
            '<div class="no-bookings-text">Share your styling link or promote "Let Us Style You" to start filling slots.</div>' +
          '</div>';
        return;
      }

      list.innerHTML = '';
      bookings.forEach(function(b) {
        var customerName = (b.customer && b.customer.name) ? b.customer.name : 'Unknown';
        var occasion = (b.answers.occasion || []).join(', ') || '—';
        var card = document.createElement('div');
        card.className = 'booking-card';
        card.setAttribute('role', 'listitem');
        card.setAttribute('tabindex', '0');
        card.onclick = function(e) {
          if (!e.target.closest('.booking-actions')) {
            openBookingModal(b.id);
          }
        };
        card.onkeydown = function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openBookingModal(b.id);
          }
        };
        var actionBtns = '<button class="booking-action-btn" onclick="event.stopPropagation(); openBookingModal(\'' + b.id + '\')" aria-label="View quiz details">View</button>';
        if (b.status === 'pending') {
          actionBtns += '<button class="booking-action-btn confirm" onclick="event.stopPropagation(); updateBookingStatus(\'' + b.id + '\', \'confirmed\')" aria-label="Confirm booking">Confirm</button>';
        }
        if (b.status === 'confirmed') {
          actionBtns += '<button class="booking-action-btn complete" onclick="event.stopPropagation(); updateBookingStatus(\'' + b.id + '\', \'completed\')" aria-label="Mark as completed">Complete</button>';
        }
        actionBtns += '<button class="booking-action-btn delete" onclick="event.stopPropagation(); deleteBooking(\'' + b.id + '\')" aria-label="Delete booking">Delete</button>';

        card.innerHTML =
          '<div class="booking-info">' +
            '<div class="booking-client-name">' + customerName + '</div>' +
            '<div class="booking-datetime">' + formatBookingDate(b.booking.date) + ' at ' + formatTime(b.booking.time) + '</div>' +
            '<div class="booking-occasion">' + occasion + '</div>' +
          '</div>' +
          '<div class="booking-meta">' +
            '<span class="booking-status status-' + b.status + '">' + b.status + '</span>' +
            '<div class="booking-actions">' + actionBtns + '</div>' +
          '</div>';
        list.appendChild(card);
      });
    }

    async function updateBookingStatus(id, status) {
      // Update in Firebase - real-time listener will update UI automatically
      await updateBookingStatusInFirebase(id, status);
    }

    async function deleteBooking(id) {
      showConfirm('Delete Booking', 'Are you sure you want to delete this booking?', 'Delete', async function() {
        await deleteBookingFromFirebase(id);
        closeBookingModal();
      }, true);
    }

    function openBookingModal(id) {
      var bookings = getBookings();
      var b = bookings.find(function(x) { return x.id === id; });
      if (!b) return;

      var customerName = (b.customer && b.customer.name) ? b.customer.name : 'Unknown';
      var customerPhone = (b.customer && b.customer.phone) ? b.customer.phone : '-';

      var body = document.getElementById('bookingModalBody');
      body.innerHTML =
        '<div class="booking-detail-row">' +
          '<span class="booking-detail-label">Customer</span>' +
          '<span class="booking-detail-value large">' + customerName + '</span>' +
        '</div>' +
        '<div class="booking-detail-row">' +
          '<span class="booking-detail-label">Phone</span>' +
          '<span class="booking-detail-value large">' + customerPhone + '</span>' +
        '</div>' +
        '<div class="booking-detail-row">' +
          '<span class="booking-detail-label">Date</span>' +
          '<span class="booking-detail-value">' + formatBookingDate(b.booking.date) + '</span>' +
        '</div>' +
        '<div class="booking-detail-row">' +
          '<span class="booking-detail-label">Time</span>' +
          '<span class="booking-detail-value">' + formatTime(b.booking.time) + '</span>' +
        '</div>' +
        '<div class="booking-detail-row">' +
          '<span class="booking-detail-label">Status</span>' +
          '<span class="booking-detail-value"><span class="booking-status status-' + b.status + '">' + b.status + '</span></span>' +
        '</div>' +
        '<div class="booking-detail-row">' +
          '<span class="booking-detail-label">Occasion</span>' +
          '<span class="booking-detail-value">' + (b.answers.occasion || []).join(', ') + '</span>' +
        '</div>' +
        '<div class="booking-detail-row">' +
          '<span class="booking-detail-label">Fit Preference</span>' +
          '<span class="booking-detail-value">' + (b.answers.fit || []).join(', ') + '</span>' +
        '</div>' +
        '<div class="booking-detail-row">' +
          '<span class="booking-detail-label">Colours</span>' +
          '<span class="booking-detail-value">' + (b.answers.colour || []).join(', ') + '</span>' +
        '</div>' +
        '<div class="booking-detail-row">' +
          '<span class="booking-detail-label">Budget</span>' +
          '<span class="booking-detail-value">' + (b.answers.budget || '-') + '</span>' +
        '</div>' +
        '<div class="booking-detail-row">' +
          '<span class="booking-detail-label">Size</span>' +
          '<span class="booking-detail-value">' + (b.answers.size || '-') + '</span>' +
        '</div>' +
        '<a href="https://wa.me/' + formatPhoneForWhatsApp(customerPhone) + '?text=' + encodeURIComponent('Hi ' + customerName + ', this is Joanne from Studio Style MCR regarding your styling session on ' + formatBookingDate(b.booking.date) + ' at ' + formatTime(b.booking.time) + '.') + '" target="_blank" class="whatsapp-btn"><i class="fab fa-whatsapp"></i> Message on WhatsApp</a>';

      document.getElementById('bookingModal').classList.add('show');
    }

    function closeBookingModal() {
      document.getElementById('bookingModal').classList.remove('show');
    }

    // Slot View
    function renderSlotView(date) {
      selectedCalendarDate = date;
      var panel = document.getElementById('slotViewPanel');
      var grid = document.getElementById('slotsGrid');
      var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

      document.getElementById('slotViewTitle').textContent = days[date.getDay()];
      document.getElementById('slotViewDate').textContent = date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();

      var dayBookings = getBookingsForDate(date);

      grid.innerHTML = '';
      TIME_SLOTS.forEach(function(slot) {
        var booking = dayBookings.find(function(b) { return b.booking.time === slot.time; });
        var item = document.createElement('div');
        item.className = 'slot-item ' + (booking ? 'booked' : 'available');

        if (booking) {
          var customerName = (booking.customer && booking.customer.name) ? booking.customer.name : 'Booked';
          item.innerHTML =
            '<div class="slot-time">' + slot.label + '</div>' +
            '<div class="slot-status booked">' + customerName + '</div>' +
            '<button class="slot-action-btn" onclick="openBookingModal(\'' + booking.id + '\')">View details</button>';
        } else {
          item.innerHTML =
            '<div class="slot-time">' + slot.label + '</div>' +
            '<div class="slot-status">Available</div>';
        }
        grid.appendChild(item);
      });

      panel.classList.add('show');

      // Update calendar selection
      document.querySelectorAll('.calendar-day.selected').forEach(function(el) {
        el.classList.remove('selected');
      });
    }

    function closeSlotView() {
      selectedCalendarDate = null;
      document.getElementById('slotViewPanel').classList.remove('show');
      document.querySelectorAll('.calendar-day.selected').forEach(function(el) {
        el.classList.remove('selected');
      });
    }

    function renderCalendar() {
      var grid = document.getElementById('calendarGrid');
      var monthLabel = document.getElementById('calendarMonth');
      var bookings = getBookings().filter(function(b) { return b.status !== 'cancelled'; });

      var year = currentCalendarDate.getFullYear();
      var month = currentCalendarDate.getMonth();

      var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      monthLabel.textContent = months[month] + ' ' + year;

      var firstDay = new Date(year, month, 1);
      var lastDay = new Date(year, month + 1, 0);
      var startDay = firstDay.getDay();
      if (startDay === 0) startDay = 7;
      startDay--;

      var daysInMonth = lastDay.getDate();
      var today = new Date();
      today.setHours(0, 0, 0, 0);

      grid.innerHTML = '';

      // Header row
      ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(function(day, idx) {
        var header = document.createElement('div');
        header.className = 'calendar-header';
        if (idx >= 3) header.classList.add('weekend');
        header.textContent = day;
        grid.appendChild(header);
      });

      // Previous month days
      var prevMonthDate = new Date(year, month, 0);
      var prevDays = prevMonthDate.getDate();
      for (var i = startDay - 1; i >= 0; i--) {
        var dayEl = document.createElement('div');
        dayEl.className = 'calendar-day other-month';
        dayEl.setAttribute('aria-hidden', 'true');
        dayEl.innerHTML = '<div class="calendar-day-number">' + (prevDays - i) + '</div>';
        grid.appendChild(dayEl);
      }

      // Current month days
      for (var d = 1; d <= daysInMonth; d++) {
        var currentDate = new Date(year, month, d);
        var dayOfWeek = currentDate.getDay();
        var isAvailable = isAvailableDay(currentDate);
        var isPast = currentDate < today;

        var dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';

        if (!isAvailable || isPast) {
          dayEl.classList.add('disabled');
          dayEl.setAttribute('aria-disabled', 'true');
        } else {
          dayEl.setAttribute('tabindex', '0');
          dayEl.setAttribute('role', 'button');
          (function(date) {
            dayEl.onclick = function() { selectDay(date, this); };
            dayEl.onkeydown = function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                selectDay(date, this);
              }
            };
          })(currentDate);
        }

        if (currentDate.toDateString() === today.toDateString()) {
          dayEl.classList.add('today');
        }

        // Count bookings for this day
        var dayBookings = bookings.filter(function(b) {
          var bDate = new Date(b.booking.date);
          return bDate.getFullYear() === year && bDate.getMonth() === month && bDate.getDate() === d;
        });

        var bookingCount = dayBookings.length;

        if (isAvailable && !isPast) {
          if (bookingCount >= TIME_SLOTS.length) {
            dayEl.classList.add('fully-booked');
          }
          dayEl.setAttribute('data-tooltip', bookingCount + ' / ' + TIME_SLOTS.length + ' slots booked');
          dayEl.setAttribute('aria-label', d + ' ' + months[month] + ', ' + bookingCount + ' of ' + TIME_SLOTS.length + ' slots booked');
        }

        var dayContent = '<div class="calendar-day-number">' + d + '</div>';

        // Add indicators
        if (isAvailable && !isPast && bookingCount > 0) {
          dayContent += '<div class="calendar-day-indicators">';
          for (var i = 0; i < Math.min(bookingCount, 4); i++) {
            var indicatorClass = dayBookings[i] && dayBookings[i].status === 'confirmed' ? 'confirmed' : '';
            dayContent += '<div class="calendar-day-indicator ' + indicatorClass + '"></div>';
          }
          dayContent += '</div>';
        }

        dayEl.innerHTML = dayContent;
        grid.appendChild(dayEl);
      }

      // Next month days
      var totalCells = startDay + daysInMonth;
      var remaining = 7 - (totalCells % 7);
      if (remaining < 7) {
        for (var i = 1; i <= remaining; i++) {
          var dayEl = document.createElement('div');
          dayEl.className = 'calendar-day other-month';
          dayEl.setAttribute('aria-hidden', 'true');
          dayEl.innerHTML = '<div class="calendar-day-number">' + i + '</div>';
          grid.appendChild(dayEl);
        }
      }
    }

    function selectDay(date, element) {
      document.querySelectorAll('.calendar-day.selected').forEach(function(el) {
        el.classList.remove('selected');
      });
      element.classList.add('selected');
      renderSlotView(date);
    }

    function prevMonth() {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
      renderCalendar();
      closeSlotView();
    }

    function nextMonth() {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
      renderCalendar();
      closeSlotView();
    }

    // TOGGLE PRODUCT LIST
    function toggleProductList() {
      var container = document.getElementById('tableContainer');
      var btn = document.getElementById('showMoreBtn');
      var isCollapsed = container.classList.contains('collapsed');

      if (isCollapsed) {
        container.classList.remove('collapsed');
        btn.innerHTML = 'Show Less <i class="fas fa-chevron-down"></i>';
      } else {
        container.classList.add('collapsed');
        btn.innerHTML = 'Show All Products <i class="fas fa-chevron-down"></i>';
      }
    }

    // ============================================
    // SALES / PAYMENTS MANAGEMENT
    // ============================================
    var ordersCache = [];
    var adminOrdersUnsubscribe = null;

    async function loadPayments() {
      try {
        document.getElementById('salesTableBody').innerHTML =
          '<tr><td colspan="6" style="text-align:center; padding: 30px; color: #999;">Loading orders...</td></tr>';

        // Set up real-time listener for Firebase orders
        if (adminOrdersUnsubscribe) adminOrdersUnsubscribe();

        adminOrdersUnsubscribe = db.collection('orders')
          .orderBy('createdAt', 'desc')
          .limit(100)
          .onSnapshot(function(snapshot) {
            ordersCache = [];
            snapshot.forEach(function(doc) {
              var data = doc.data();
              ordersCache.push({
                id: doc.id,
                ...data,
                // Normalize the timestamp
                created: data.createdAt ? data.createdAt.toDate().getTime() / 1000 : (data.stripeCreated || Date.now() / 1000)
              });
            });
            renderSalesTable();
            updateSalesSummary();
          }, function(error) {
            console.error('Error loading orders:', error);
            document.getElementById('salesTableBody').innerHTML =
              '<tr><td colspan="6" style="text-align:center; padding: 30px; color: #e74c3c;">Error loading orders: ' + error.message + '</td></tr>';
          });

        document.getElementById('salesPagination').style.display = 'none';
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('salesTableBody').innerHTML =
          '<tr><td colspan="6" style="text-align:center; padding: 30px; color: #e74c3c;">Error loading orders: ' + error.message + '</td></tr>';
      }
    }

    function loadMorePayments() {
      // No longer needed with real-time listener
    }

    function renderSalesTable() {
      var tbody = document.getElementById('salesTableBody');

      if (ordersCache.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 30px; color: #999;">No orders yet.</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      ordersCache.forEach(function(order) {
        var date = new Date(order.created * 1000);
        var dateStr = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        var timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

        var amount = (order.total || 0).toFixed(2);
        var customerName = order.customerInfo ? (order.customerInfo.firstName + ' ' + order.customerInfo.lastName).trim() : 'Guest';
        var customerEmail = order.customerInfo ? order.customerInfo.email : '';

        var statusClass = order.status === 'paid' ? 'status-active' : 'status-pending';
        var statusText = order.status === 'paid' ? 'Paid' : (order.status === 'pending' ? 'Pending' : order.status);

        var delivery = order.deliveryOption || 'standard';
        var deliveryLabel = delivery === 'collection' ? 'Collection' :
                           delivery === 'dropoff' ? 'Drop-off' :
                           delivery === 'express' ? 'Express' :
                           delivery === 'free' ? 'Free' : 'Standard';

        var paymentBadge = order.paymentMethod === 'cash' ?
          '<span class="collection-badge badge-last-chance">Cash</span>' :
          '<span class="collection-badge badge-accessories">Card</span>';

        var row = document.createElement('tr');
        row.innerHTML =
          '<td><div style="font-weight:500;">' + dateStr + '</div><div style="font-size:0.75rem;color:#999;">' + timeStr + '</div></td>' +
          '<td><div style="font-weight:500;">' + customerName + '</div><div style="font-size:0.75rem;color:#999;">' + customerEmail + '</div></td>' +
          '<td>' + paymentBadge + ' <span class="collection-badge badge-new">' + deliveryLabel + '</span></td>' +
          '<td><div style="font-weight:500;">&pound;' + amount + '</div>' +
            (order.couponCode ? '<div style="font-size:0.75rem;color:#2e7d32;">Code: ' + order.couponCode + '</div>' : '') + '</td>' +
          '<td><span class="' + statusClass + '">' + statusText + '</span></td>' +
          '<td><div class="action-btns">' +
            '<button class="edit-btn" onclick="viewFirebaseOrder(\'' + order.id + '\')">View</button>' +
            '<button class="delete-btn" onclick="deleteOrder(\'' + order.id + '\')">Delete</button>' +
          '</div></td>';
        tbody.appendChild(row);
      });
    }

    function updateSalesSummary() {
      var now = new Date();
      var todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() / 1000;
      var weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay()).getTime() / 1000;
      var monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime() / 1000;

      var todayTotal = 0;
      var weekTotal = 0;
      var monthTotal = 0;
      var orderCount = ordersCache.length;

      ordersCache.forEach(function(order) {
        var amount = order.total || 0;
        if (order.created >= todayStart) todayTotal += amount;
        if (order.created >= weekStart) weekTotal += amount;
        if (order.created >= monthStart) monthTotal += amount;
      });

      // Update Sales tab summary
      document.getElementById('salesToday').textContent = '£' + todayTotal.toFixed(2);
      document.getElementById('salesWeek').textContent = '£' + weekTotal.toFixed(2);
      document.getElementById('salesTotal').textContent = orderCount;

      // Update top stats cards
      document.getElementById('statSalesToday').textContent = '£' + todayTotal.toFixed(2);
      document.getElementById('statSalesWeek').textContent = '£' + weekTotal.toFixed(2);
      document.getElementById('statSalesMonth').textContent = '£' + monthTotal.toFixed(2);
      document.getElementById('statOrdersTotal').textContent = orderCount;
    }

    // Load sales stats on page load (background)
    async function loadSalesStats() {
      try {
        var snapshot = await db.collection('orders').orderBy('createdAt', 'desc').limit(100).get();
        ordersCache = [];
        snapshot.forEach(function(doc) {
          var data = doc.data();
          ordersCache.push({
            id: doc.id,
            ...data,
            created: data.createdAt ? data.createdAt.toDate().getTime() / 1000 : Date.now() / 1000
          });
        });
        updateSalesSummary();
      } catch (e) {
        console.log('Could not load sales stats:', e);
      }
    }

    function viewFirebaseOrder(orderId) {
      var order = ordersCache.find(function(o) { return o.id === orderId; });
      if (!order) return;

      var date = new Date(order.created * 1000);
      var dateStr = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
      var timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
      var ci = order.customerInfo || {};
      var customerName = ((ci.firstName || '') + ' ' + (ci.lastName || '')).trim() || 'Guest';

      var deliveryLabels = { standard: 'Standard Delivery (3-5 days)', express: 'Express Delivery (1-2 days)', free: 'Free Delivery', collection: 'Collection', dropoff: 'Drop-off' };
      var deliveryLabel = deliveryLabels[order.deliveryOption] || order.deliveryOption || 'Standard';
      var paymentLabel = order.paymentMethod === 'cash' ? 'Cash' : 'Card (Stripe)';
      var paymentIcon = order.paymentMethod === 'cash' ? '<i class="fas fa-money-bill-wave" style="color:#2e7d32;"></i>' : '<i class="fas fa-credit-card" style="color:#635bff;"></i>';
      var statusLabel = order.status === 'paid' ? 'Succeeded' : (order.status === 'pending' ? 'Pending' : (order.status || 'Unknown'));
      var statusColor = order.status === 'paid' ? '#2e7d32' : '#e67e22';
      var statusBg = order.status === 'paid' ? '#e8f5e9' : '#fff3e0';

      // Items table
      var itemsHTML = '<table style="width:100%; border-collapse:collapse;">' +
        '<thead><tr>' +
          '<th style="text-align:left; padding:10px 0; font-size:0.6rem; letter-spacing:1.5px; text-transform:uppercase; color:#697386; border-bottom:1px solid #e3e8ee;">ITEMS</th>' +
          '<th style="text-align:center; padding:10px 0; font-size:0.6rem; letter-spacing:1.5px; text-transform:uppercase; color:#697386; border-bottom:1px solid #e3e8ee;">QTY</th>' +
          '<th style="text-align:right; padding:10px 0; font-size:0.6rem; letter-spacing:1.5px; text-transform:uppercase; color:#697386; border-bottom:1px solid #e3e8ee;">UNIT PRICE</th>' +
          '<th style="text-align:right; padding:10px 0; font-size:0.6rem; letter-spacing:1.5px; text-transform:uppercase; color:#697386; border-bottom:1px solid #e3e8ee;">AMOUNT</th>' +
        '</tr></thead><tbody>';
      (order.items || []).forEach(function(item) {
        var lineTotal = ((item.price || 0) * (item.quantity || 1)).toFixed(2);
        itemsHTML += '<tr>' +
          '<td style="padding:12px 0; border-bottom:1px solid #f0f4f8; font-size:0.85rem; font-weight:500;">' + (item.name || 'Item') + '</td>' +
          '<td style="padding:12px 0; border-bottom:1px solid #f0f4f8; text-align:center; color:#697386;">' + (item.quantity || 1) + '</td>' +
          '<td style="padding:12px 0; border-bottom:1px solid #f0f4f8; text-align:right; color:#697386;">&pound;' + (item.price || 0).toFixed(2) + '</td>' +
          '<td style="padding:12px 0; border-bottom:1px solid #f0f4f8; text-align:right; font-weight:500;">&pound;' + lineTotal + '</td>' +
        '</tr>';
      });
      if ((order.items || []).length === 0) {
        itemsHTML += '<tr><td colspan="4" style="padding:20px 0; text-align:center; color:#697386;">No items recorded</td></tr>';
      }
      itemsHTML += '</tbody></table>';

      // Discounts
      var discountsHTML = '';
      if (order.couponCode) {
        discountsHTML += '<div style="display:flex; justify-content:space-between; padding:8px 0; font-size:0.85rem;">' +
          '<div style="color:#697386;"><i class="fas fa-tag" style="margin-right:6px;"></i>Coupon: <span style="font-weight:500; color:#333;">' + order.couponCode + '</span></div>' +
          '<div style="color:#2e7d32; font-weight:500;">-&pound;' + (order.couponDiscount || 0).toFixed(2) + '</div></div>';
      }
      if (order.rewardUsed) {
        discountsHTML += '<div style="display:flex; justify-content:space-between; padding:8px 0; font-size:0.85rem;">' +
          '<div style="color:#697386;"><i class="fas fa-gift" style="margin-right:6px;"></i>Loyalty Reward</div>' +
          '<div style="color:#2e7d32; font-weight:500;">-&pound;' + (order.rewardDiscount || 20).toFixed(2) + '</div></div>';
      }

      // Delivery cost display
      var deliveryPrices = { standard: 3.99, express: 5.99, free: 0, collection: 0, dropoff: 0 };
      var delCost = deliveryPrices[order.deliveryOption] !== undefined ? deliveryPrices[order.deliveryOption] : 0;

      // Address lines
      var addressLines = [ci.address, ci.city, ci.postcode].filter(Boolean);

      var body = document.getElementById('orderModalBody');
      body.innerHTML =
        // TOP BAR
        '<div style="background:#fff; padding:24px 30px; border-bottom:1px solid #e3e8ee; border-radius:8px 8px 0 0; display:flex; justify-content:space-between; align-items:center;">' +
          '<div style="font-size:0.7rem; color:#697386; letter-spacing:0.5px;">' +
            '<a onclick="closeOrderModal()" style="color:#635bff; cursor:pointer; text-decoration:none; font-weight:500;">Orders</a>' +
            ' <span style="margin:0 6px;">&rsaquo;</span> ' + (order.orderNumber || order.id) +
          '</div>' +
          '<button onclick="closeOrderModal()" style="background:none; border:1px solid #e3e8ee; border-radius:6px; width:32px; height:32px; font-size:1.1rem; cursor:pointer; color:#697386; display:flex; align-items:center; justify-content:center;">&times;</button>' +
        '</div>' +

        // MAIN CONTENT - two columns
        '<div style="display:flex; gap:0; min-height:500px;">' +

          // LEFT COLUMN
          '<div style="flex:1; padding:30px; background:#fff; border-right:1px solid #e3e8ee;">' +

            // Amount + Status
            '<div style="margin-bottom:28px;">' +
              '<div style="font-size:2rem; font-weight:600; color:#1a1d23; margin-bottom:6px;">&pound;' + (order.total || 0).toFixed(2) + ' <span style="font-size:0.9rem; font-weight:400; color:#697386;">GBP</span> ' +
                '<span style="display:inline-block; background:' + statusBg + '; color:' + statusColor + '; font-size:0.65rem; font-weight:600; padding:3px 10px; border-radius:20px; vertical-align:middle; letter-spacing:0.5px;">' + statusLabel + ' <i class="fas fa-check" style="font-size:0.55rem;"></i></span>' +
              '</div>' +
              '<div style="font-size:0.8rem; color:#697386;">Charged to <span style="color:#635bff; font-weight:500;">' + customerName + '</span></div>' +
            '</div>' +

            // Timeline
            '<div style="margin-bottom:28px;">' +
              '<div style="font-size:0.95rem; font-weight:600; color:#1a1d23; margin-bottom:16px;">Recent activity</div>' +
              '<div style="display:flex; align-items:flex-start; gap:12px; margin-bottom:14px;">' +
                '<div style="width:24px; height:24px; border-radius:50%; background:' + statusBg + '; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:2px;">' +
                  '<i class="fas fa-check" style="font-size:0.55rem; color:' + statusColor + ';"></i>' +
                '</div>' +
                '<div>' +
                  '<div style="font-size:0.85rem; font-weight:500; color:#1a1d23;">Payment ' + (order.status === 'paid' ? 'authorised' : 'started') + '</div>' +
                  '<div style="font-size:0.75rem; color:#697386;">' + dateStr + ', ' + timeStr + '</div>' +
                '</div>' +
              '</div>' +
              '<div style="display:flex; align-items:flex-start; gap:12px;">' +
                '<div style="width:24px; height:24px; border-radius:50%; background:#f0f4f8; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:2px;">' +
                  '<i class="fas fa-shopping-cart" style="font-size:0.55rem; color:#697386;"></i>' +
                '</div>' +
                '<div>' +
                  '<div style="font-size:0.85rem; font-weight:500; color:#1a1d23;">Order created</div>' +
                  '<div style="font-size:0.75rem; color:#697386;">' + dateStr + ', ' + timeStr + '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +

            // Checkout summary
            '<div style="margin-bottom:28px;">' +
              '<div style="font-size:0.95rem; font-weight:600; color:#1a1d23; margin-bottom:16px;">Checkout summary</div>' +
              '<div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">' +
                '<div>' +
                  '<div style="font-size:0.75rem; color:#697386; margin-bottom:8px;">Customer</div>' +
                  '<div style="font-size:0.85rem; color:#1a1d23;">' + (ci.email || 'N/A') + '</div>' +
                  '<div style="font-size:0.85rem; color:#1a1d23; margin-top:8px;">' + customerName + '</div>' +
                  (addressLines.length > 0 ? addressLines.map(function(l) { return '<div style="font-size:0.85rem; color:#1a1d23;">' + l + '</div>'; }).join('') : '') +
                '</div>' +
                '<div>' +
                  '<div style="font-size:0.75rem; color:#697386; margin-bottom:8px;">Shipping details</div>' +
                  '<div style="font-size:0.85rem; color:#1a1d23;">' + customerName + '</div>' +
                  (addressLines.length > 0 ? addressLines.map(function(l) { return '<div style="font-size:0.85rem; color:#1a1d23;">' + l + '</div>'; }).join('') : '<div style="font-size:0.85rem; color:#697386;">N/A</div>') +
                '</div>' +
              '</div>' +
            '</div>' +

            // Items table
            '<div>' + itemsHTML + '</div>' +

            // Delivery line
            '<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #f0f4f8; font-size:0.85rem;">' +
              '<div style="color:#697386;"><i class="fas fa-truck" style="margin-right:6px;"></i>' + deliveryLabel + '</div>' +
              '<div style="font-weight:500;">' + (delCost > 0 ? '&pound;' + delCost.toFixed(2) : 'Free') + '</div>' +
            '</div>' +

            // Discounts
            (discountsHTML ? '<div style="border-bottom:1px solid #f0f4f8;">' + discountsHTML + '</div>' : '') +

            // Total
            '<div style="display:flex; justify-content:space-between; padding:14px 0; font-size:1.05rem; font-weight:600; color:#1a1d23;">' +
              '<div>Total</div><div>&pound;' + (order.total || 0).toFixed(2) + '</div>' +
            '</div>' +

          '</div>' +

          // RIGHT COLUMN - Details sidebar
          '<div style="width:280px; padding:30px 24px; background:#f6f8fa; flex-shrink:0; border-radius:0 0 8px 0;">' +

            '<div style="font-size:0.95rem; font-weight:600; color:#1a1d23; margin-bottom:20px;">Details</div>' +

            '<div style="margin-bottom:18px;">' +
              '<div style="font-size:0.75rem; font-weight:600; color:#1a1d23; margin-bottom:4px;">Order ID</div>' +
              '<div style="font-size:0.8rem; color:#697386; word-break:break-all;">' + (order.orderNumber || order.id) + '</div>' +
            '</div>' +

            '<div style="margin-bottom:18px;">' +
              '<div style="font-size:0.75rem; font-weight:600; color:#1a1d23; margin-bottom:4px;">Payment method</div>' +
              '<div style="font-size:0.8rem; color:#697386;">' + paymentIcon + ' &nbsp;' + paymentLabel + '</div>' +
            '</div>' +

            '<div style="margin-bottom:18px;">' +
              '<div style="font-size:0.75rem; font-weight:600; color:#1a1d23; margin-bottom:4px;">Delivery method</div>' +
              '<div style="font-size:0.8rem; color:#697386;">' + deliveryLabel + '</div>' +
            '</div>' +

            '<div style="margin-bottom:18px;">' +
              '<div style="font-size:0.75rem; font-weight:600; color:#1a1d23; margin-bottom:4px;">Last updated</div>' +
              '<div style="font-size:0.8rem; color:#697386;">' + dateStr + ', ' + timeStr + '</div>' +
            '</div>' +

            '<div style="border-top:1px solid #e3e8ee; padding-top:20px; margin-top:20px;">' +
              '<div style="font-size:0.95rem; font-weight:600; color:#1a1d23; margin-bottom:16px;">Customer</div>' +

              '<div style="margin-bottom:14px;">' +
                '<div style="font-size:0.75rem; font-weight:600; color:#1a1d23; margin-bottom:4px;">Name</div>' +
                '<div style="font-size:0.8rem; color:#697386;">' + customerName + '</div>' +
              '</div>' +

              '<div style="margin-bottom:14px;">' +
                '<div style="font-size:0.75rem; font-weight:600; color:#1a1d23; margin-bottom:4px;">Email address</div>' +
                '<div style="font-size:0.8rem; color:#697386; word-break:break-all;">' + (ci.email || 'N/A') + '</div>' +
              '</div>' +

              '<div style="margin-bottom:14px;">' +
                '<div style="font-size:0.75rem; font-weight:600; color:#1a1d23; margin-bottom:4px;">Phone number</div>' +
                '<div style="font-size:0.8rem; color:#697386;">' + (ci.phone || 'N/A') + '</div>' +
              '</div>' +

              '<div style="margin-bottom:14px;">' +
                '<div style="font-size:0.75rem; font-weight:600; color:#1a1d23; margin-bottom:4px;">Address</div>' +
                (addressLines.length > 0 ? addressLines.map(function(l) { return '<div style="font-size:0.8rem; color:#697386;">' + l + '</div>'; }).join('') : '<div style="font-size:0.8rem; color:#697386;">N/A</div>') +
              '</div>' +

            '</div>' +

            (order.userId ? '<div style="border-top:1px solid #e3e8ee; padding-top:14px; margin-top:14px;">' +
              '<div style="font-size:0.75rem; font-weight:600; color:#1a1d23; margin-bottom:4px;">User ID</div>' +
              '<div style="font-size:0.7rem; color:#697386; word-break:break-all;">' + order.userId + '</div>' +
            '</div>' : '') +

          '</div>' +

        '</div>';

      document.getElementById('orderModalOverlay').classList.add('show');
    }

    function closeOrderModal() {
      document.getElementById('orderModalOverlay').classList.remove('show');
    }

    async function deleteOrder(orderId) {
      showConfirm('Delete Order', 'Are you sure you want to delete this order?', 'Delete', async function() {
        try {
          await db.collection('orders').doc(orderId).delete();
        } catch (error) {
          showAlert('Error', 'Error deleting order: ' + error.message);
        }
      }, true);
    }

    function viewOrder(sessionId) {
      // Legacy function for Stripe orders - redirect to Firebase view
      viewFirebaseOrder(sessionId);
    }

    async function refundOrder(paymentIntentId, maxAmount) {
      var amountStr = prompt('Enter refund amount in pence (max ' + maxAmount + ' = £' + (maxAmount/100).toFixed(2) + ')\\nLeave blank for full refund:', '');

      if (amountStr === null) return; // Cancelled

      var amount = amountStr.trim() === '' ? null : parseInt(amountStr);
      if (amount !== null && (isNaN(amount) || amount <= 0 || amount > maxAmount)) {
        showAlert('Invalid Amount', 'Invalid refund amount');
        return;
      }

      var refundLabel = amount ? '£' + (amount/100).toFixed(2) : 'the full amount';
      showConfirm('Confirm Refund', 'Are you sure you want to refund ' + refundLabel + '?', 'Refund', async function() {
        try {
          var response = await fetch('/api/create-refund', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paymentIntentId: paymentIntentId,
              amount: amount,
              reason: 'requested_by_customer'
            })
          });

          var data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }

          showAlert('Refund Successful', 'Refund processed successfully! Refund ID: ' + data.refund.id);
          loadPayments();
        } catch (error) {
          showAlert('Error', 'Error processing refund: ' + error.message);
        }
      }, true);
    }

    // ============================================
    // DISCOUNT CODES MANAGEMENT
    // ============================================
    var discountsCache = [];
    var editingDiscountId = null;

    async function loadDiscounts() {
      try {
        var snapshot = await db.collection('discountCodes').get();
        discountsCache = [];
        snapshot.forEach(function(doc) {
          discountsCache.push({ id: doc.id, ...doc.data() });
        });
        renderDiscountsTable();
      } catch (error) {
        console.error('Error loading discounts:', error);
        document.getElementById('discountTableBody').innerHTML =
          '<tr><td colspan="5" style="text-align:center; padding: 30px; color: #e74c3c;">Error loading discount codes</td></tr>';
      }
    }

    function renderDiscountsTable() {
      var tbody = document.getElementById('discountTableBody');

      if (discountsCache.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 30px; color: #999;">No discount codes yet. Click "Add Code" to create one.</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      discountsCache.forEach(function(d) {
        var discountText = d.type === 'percent' ? d.value + '%' : '£' + d.value;
        var typeText = d.type === 'percent' ? 'Percentage' : 'Fixed Amount';
        var statusClass = d.enabled ? 'status-active' : 'status-sale';
        var statusText = d.enabled ? 'Active' : 'Disabled';

        var row = document.createElement('tr');
        row.innerHTML =
          '<td><strong style="letter-spacing: 1px;">' + d.code.toUpperCase() + '</strong></td>' +
          '<td>' + discountText + '</td>' +
          '<td>' + typeText + '</td>' +
          '<td><span class="' + statusClass + '">' + statusText + '</span></td>' +
          '<td><div class="action-btns">' +
            '<button class="edit-btn" onclick="openDiscountModal(\'' + d.id + '\')">Edit</button>' +
            '<button class="delete-btn" onclick="deleteDiscount(\'' + d.id + '\')">Delete</button>' +
          '</div></td>';
        tbody.appendChild(row);
      });
    }

    function openDiscountModal(id) {
      if (id) {
        // Edit mode
        var discount = discountsCache.find(function(d) { return d.id === id; });
        if (!discount) return;
        editingDiscountId = id;
        document.getElementById('discountModalTitle').textContent = 'Edit Discount Code';
        document.getElementById('discountCode').value = discount.code;
        document.getElementById('discountType').value = discount.type;
        document.getElementById('discountValue').value = discount.value;
        document.getElementById('discountEnabled').checked = discount.enabled;
      } else {
        // Add mode
        editingDiscountId = null;
        document.getElementById('discountModalTitle').textContent = 'Add Discount Code';
        document.getElementById('discountCode').value = '';
        document.getElementById('discountType').value = 'percent';
        document.getElementById('discountValue').value = '';
        document.getElementById('discountEnabled').checked = true;
      }
      document.getElementById('discountModalOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeDiscountModal() {
      document.getElementById('discountModalOverlay').classList.remove('show');
      document.body.style.overflow = '';
      editingDiscountId = null;
    }

    async function saveDiscount() {
      var code = document.getElementById('discountCode').value.trim().toUpperCase();
      var type = document.getElementById('discountType').value;
      var value = parseFloat(document.getElementById('discountValue').value);
      var enabled = document.getElementById('discountEnabled').checked;

      if (!code) { showAlert('Missing Code', 'Please enter a discount code'); return; }
      if (isNaN(value) || value <= 0) { showAlert('Invalid Value', 'Please enter a valid discount value'); return; }

      var discountData = {
        code: code,
        type: type,
        value: value,
        enabled: enabled,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        if (editingDiscountId) {
          // Update existing
          await db.collection('discountCodes').doc(editingDiscountId).update(discountData);
        } else {
          // Check if code already exists
          var existing = discountsCache.find(function(d) { return d.code.toUpperCase() === code; });
          if (existing) {
            showAlert('Duplicate Code', 'This discount code already exists');
            return;
          }
          // Add new
          discountData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('discountCodes').add(discountData);
        }
        closeDiscountModal();
        loadDiscounts();
      } catch (error) {
        console.error('Error saving discount:', error);
        showAlert('Error', 'Error saving discount code: ' + error.message);
      }
    }

    async function deleteDiscount(id) {
      showConfirm('Delete Discount', 'Are you sure you want to delete this discount code?', 'Delete', async function() {
        try {
          await db.collection('discountCodes').doc(id).delete();
          loadDiscounts();
        } catch (error) {
          console.error('Error deleting discount:', error);
          showAlert('Error', 'Error deleting discount code. Please try again.');
        }
      }, true);
    }

    // INIT
    if (sessionStorage.getItem('adminAuth') === 'true') {
      showDashboard();
    }
  </script>

<!-- Mobile Action Menu -->
<div class="action-popup" id="actionPopup" onclick="closeActionMenu()">
  <div class="action-popup-menu" onclick="event.stopPropagation()">
    <div class="action-popup-title" id="actionPopupTitle">Product</div>
    <button class="action-popup-item" onclick="actionMenuEdit()"><i class="fas fa-pen"></i> Edit</button>
    <button class="action-popup-item" onclick="actionMenuDupe()"><i class="fas fa-copy"></i> Duplicate</button>
    <button class="action-popup-item" id="actionMenuGoLiveItem" style="display:none; color:#2e7d32;" onclick="actionMenuGoLive()"><i class="fas fa-rocket" style="color:#2e7d32;"></i> Go Live</button>
    <button class="action-popup-item" id="actionMenuMoveUpItem" onclick="actionMenuMoveUp()"><i class="fas fa-arrow-up"></i> Move Up</button>
    <button class="action-popup-item" id="actionMenuMoveDownItem" onclick="actionMenuMoveDown()"><i class="fas fa-arrow-down"></i> Move Down</button>
    <button class="action-popup-item danger" onclick="actionMenuDelete()"><i class="fas fa-trash"></i> Delete</button>
    <button class="action-popup-cancel" onclick="closeActionMenu()">Cancel</button>
  </div>
</div>

<!-- Image Review Lightbox -->
<div class="image-lightbox" id="imageLightbox" onclick="closeLightbox()">
  <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
  <img id="lightboxImg" src="" alt="Image Review">
</div>

<!-- Toast Notification -->
<div class="admin-toast" id="adminToast"></div>

<!-- Apple-style Confirmation Dialog -->
<div class="confirm-overlay" id="confirmOverlay" onclick="cancelConfirm()">
  <div class="confirm-dialog" onclick="event.stopPropagation()">
    <div class="confirm-body">
      <div class="confirm-title" id="confirmTitle">Are you sure?</div>
      <div class="confirm-message" id="confirmMessage">This action cannot be undone.</div>
    </div>
    <div class="confirm-actions">
      <button class="confirm-btn cancel" id="confirmCancel" onclick="cancelConfirm()">Cancel</button>
      <button class="confirm-btn primary" id="confirmAction" onclick="executeConfirm()">Confirm</button>
    </div>
  </div>
</div>

</body>
</html>
