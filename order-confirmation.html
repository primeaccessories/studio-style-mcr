<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Confirmed | Studio Style MCR</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/cart.css?v=4">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fjalla+One&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .confirmation-section {
      min-height: calc(100vh - 200px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      background: #e8e0d6;
    }

    .confirmation-container {
      background: white;
      padding: 60px;
      max-width: 600px;
      width: 100%;
      text-align: center;
      border-radius: 4px;
    }

    .confirmation-icon {
      width: 80px;
      height: 80px;
      background: #2d5016;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 30px;
    }

    .confirmation-icon i {
      font-size: 36px;
      color: white;
    }

    .confirmation-container h1 {
      font-family: 'Fjalla One', sans-serif;
      font-size: 32px;
      margin-bottom: 15px;
      color: #1a1a1a;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .confirmation-container .subtitle {
      font-family: 'Cormorant Garamond', serif;
      font-size: 20px;
      color: #666;
      margin-bottom: 30px;
      font-style: italic;
    }

    .order-number {
      background: #f8f6f3;
      padding: 20px;
      margin: 30px 0;
      border-radius: 4px;
    }

    .order-number span {
      display: block;
      font-family: 'Cormorant Garamond', serif;
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .order-number strong {
      font-family: 'Fjalla One', sans-serif;
      font-size: 18px;
      color: #1a1a1a;
      letter-spacing: 1px;
    }

    .confirmation-details {
      text-align: left;
      margin: 30px 0;
      padding: 30px;
      background: #f8f6f3;
      border-radius: 4px;
    }

    .confirmation-details h3 {
      font-family: 'Fjalla One', sans-serif;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
      color: #1a1a1a;
    }

    .confirmation-details p {
      font-family: 'Cormorant Garamond', serif;
      font-size: 16px;
      color: #666;
      margin: 8px 0;
      line-height: 1.6;
    }

    .confirmation-message {
      font-family: 'Cormorant Garamond', serif;
      font-size: 16px;
      color: #666;
      line-height: 1.8;
      margin: 30px 0;
    }

    .confirmation-btn {
      display: inline-block;
      background: #e8e0d6;
      color: #1a1a1a;
      padding: 16px 40px;
      text-decoration: none;
      font-family: 'Fjalla One', sans-serif;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-top: 20px;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }

    .confirmation-btn:hover {
      background: #d4ccc2;
    }

    .loading-state {
      text-align: center;
      padding: 60px;
    }

    .loading-state i {
      font-size: 40px;
      color: #666;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .error-state {
      text-align: center;
    }

    .error-state i {
      font-size: 60px;
      color: #c53030;
      margin-bottom: 20px;
    }

    @media (max-width: 600px) {
      .confirmation-container {
        padding: 40px 25px;
      }

      .confirmation-container h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <a href="index.html" class="logo">STUDIO STYLE MCR</a>
    <nav class="nav">
      <i class="fas fa-search search-icon" onclick="toggleSearch()"></i>
      <a href="login.html" class="account-link"><i class="fas fa-user"></i></a>
    </nav>
  </header>

  <!-- CONFIRMATION -->
  <section class="confirmation-section">
    <div class="confirmation-container" id="confirmationContent">
      <div class="loading-state">
        <i class="fas fa-circle-notch fa-spin"></i>
        <p style="margin-top: 20px; font-family: 'Cormorant Garamond', serif; color: #666;">Loading your order details...</p>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-top">
      <div class="footer-brand">
        <div class="footer-logo">STUDIO STYLE MCR</div>
        <p>Women's fashion boutique based in Manchester. Curated style, delivered to your door.</p>
      </div>
      <div class="footer-column">
        <h4>Shop</h4>
        <a href="new-arrivals.html">New In</a>
        <a href="accessories.html">Accessories</a>
        <a href="last-chance.html">Last Chance</a>
        <a href="shop.html">All Products</a>
      </div>
      <div class="footer-column">
        <h4>Info</h4>
        <a href="about.html">About Us</a>
        <a href="contact.html">Contact</a>
        <a href="style-quiz.html">Style Quiz</a>
        <a href="returns.html">Returns</a>
        <a href="click-collect.html">Click &amp; Collect</a>
        <a href="login.html">My Account</a>
      </div>
      <div class="footer-column">
        <h4>Connect</h4>
        <a href="https://www.instagram.com/the_studio_mcr?igsh=Zmd3NXVvbGNvOXh4" target="_blank"><i class="fab fa-instagram"></i> Instagram</a>
        <a href="https://www.facebook.com/share/1D38Co16cq/?mibextid=wwXIfr" target="_blank"><i class="fab fa-facebook"></i> Facebook</a>
        <a href="https://www.tiktok.com/@thestudiomcr?_r=1&amp;_t=ZN-93QigICnc4E" target="_blank"><i class="fab fa-tiktok"></i> TikTok</a>
        <a href="https://wa.me/447802725901" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a>
      </div>
    </div>
    <div class="payment-methods">
      <div class="payment-icons">
        <i class="fab fa-cc-visa"></i>
        <i class="fab fa-cc-mastercard"></i>
        <i class="fab fa-apple-pay"></i>
        <i class="fab fa-google-pay"></i>
        <i class="fab fa-klarna"></i>
      </div>
    </div>
    <p class="copyright">&copy; 2026 Studio Style MCR. All rights reserved.</p>
  </footer>

  <!-- Search Overlay -->
  <div class="search-overlay" id="searchOverlay">
    <button class="search-close" onclick="closeSearch()">&times;</button>
    <div class="search-input-wrap">
      <input type="text" id="searchInput" placeholder="Search products..." oninput="performSearch()">
    </div>
    <div class="search-results" id="searchResults"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="js/products.js"></script>
  <script src="js/search.js"></script>
  <script src="js/auth.js?v=2"></script>
  <script>
    // Get session ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    const method = urlParams.get('method'); // For cash/collection orders

    async function loadOrderDetails() {
      const container = document.getElementById('confirmationContent');

      // Handle collection/dropoff cash orders
      if (method === 'collection' || method === 'dropoff') {
        showCollectionSuccess(method);
        return;
      }

      if (!sessionId) {
        showError();
        return;
      }

      // Clear the cart since payment was successful
      localStorage.removeItem('cart');

      // Update rewards for logged-in user
      await updateUserRewards();

      // Generate order number from session ID
      const orderNumber = 'SSM-' + sessionId.slice(-8).toUpperCase();

      // Show success message
      container.innerHTML = `
        <div class="confirmation-icon">
          <i class="fas fa-check"></i>
        </div>
        <h1>Thank You</h1>
        <p class="subtitle">Your order has been confirmed</p>

        <div class="order-number">
          <span>Order Number</span>
          <strong>${orderNumber}</strong>
        </div>

        <p class="confirmation-message">
          We've sent a confirmation email with your order details.
          Your items will be dispatched within 1-2 business days.
        </p>

        <div class="confirmation-details">
          <h3>What happens next?</h3>
          <p><i class="fas fa-envelope" style="width: 20px; color: #1a1a1a;"></i> You'll receive an email confirmation shortly</p>
          <p><i class="fas fa-box" style="width: 20px; color: #1a1a1a;"></i> We'll prepare your order for dispatch</p>
          <p><i class="fas fa-truck" style="width: 20px; color: #1a1a1a;"></i> You'll receive tracking details once shipped</p>
        </div>

        <a href="index.html" class="confirmation-btn">Continue Shopping</a>
      `;
    }

    function showError() {
      const container = document.getElementById('confirmationContent');
      container.innerHTML = `
        <div class="error-state">
          <i class="fas fa-exclamation-circle"></i>
          <h1>Oops!</h1>
          <p class="subtitle">We couldn't find your order details</p>
          <p class="confirmation-message">
            If you completed a purchase, please check your email for confirmation.
            If you have any questions, please contact us.
          </p>
          <a href="index.html" class="confirmation-btn">Return to Shop</a>
        </div>
      `;
    }

    function showCollectionSuccess(method) {
      const container = document.getElementById('confirmationContent');
      const isCollection = method === 'collection';
      localStorage.removeItem('cart');

      const whatsappMessage = encodeURIComponent(
        `Hi! I've just placed a ${isCollection ? 'collection' : 'drop-off'} order on your website and would like to arrange ${isCollection ? 'pickup' : 'delivery'}. Thank you!`
      );

      container.innerHTML = `
        <div class="confirmation-icon">
          <i class="fas fa-check"></i>
        </div>
        <h1>Order Confirmed!</h1>
        <p class="subtitle">Your ${isCollection ? 'collection' : 'drop-off'} order has been received</p>

        <div style="background: #25D366; padding: 30px; margin: 30px 0; border-radius: 8px;">
          <p style="color: white; font-family: 'Cormorant Garamond', serif; font-size: 18px; margin-bottom: 20px;">
            <strong>Next step:</strong> Message us on WhatsApp to arrange your ${isCollection ? 'collection' : 'drop-off'}
          </p>
          <a href="https://wa.me/447802725901?text=${whatsappMessage}"
             target="_blank"
             style="display: inline-flex; align-items: center; gap: 12px; background: white; color: #25D366; padding: 18px 40px; text-decoration: none; font-family: 'Fjalla One', sans-serif; font-size: 18px; text-transform: uppercase; letter-spacing: 2px; border-radius: 4px; font-weight: bold;">
            <i class="fab fa-whatsapp" style="font-size: 28px;"></i>
            Message Us Now
          </a>
        </div>

        <div class="confirmation-details">
          <h3>${isCollection ? 'Collection' : 'Drop-off'} Info</h3>
          <p><i class="fab fa-whatsapp" style="width: 20px; color: #25D366;"></i> We'll confirm ${isCollection ? 'collection time & location' : 'your delivery slot'} via WhatsApp</p>
          <p><i class="fas fa-money-bill-wave" style="width: 20px; color: #1a1a1a;"></i> Pay cash when you ${isCollection ? 'collect' : 'receive your order'}</p>
          <p><i class="fas fa-clock" style="width: 20px; color: #1a1a1a;"></i> Usually ready within 24-48 hours</p>
        </div>

        <a href="new-arrivals.html" class="confirmation-btn">Continue Shopping</a>
      `;
    }

    async function updateUserRewards() {
      try {
        const user = auth.currentUser;
        if (!user) return;

        // Check if we've already processed this session
        const processedKey = 'processed_' + sessionId;
        if (localStorage.getItem(processedKey)) return;

        // Fetch session details to get metadata
        const response = await fetch('/api/get-session?session_id=' + sessionId);
        if (!response.ok) {
          // If API doesn't exist, just increment order count
          const userDoc = await db.collection('users').doc(user.uid).get();
          const userData = userDoc.data();
          const currentCount = (userData.rewards && userData.rewards.orderCount) || 0;
          const newCount = currentCount + 1;

          const rewardUpdate = { 'rewards.orderCount': newCount };
          if (newCount % 5 === 0) {
            rewardUpdate['rewards.rewardAvailable'] = true;
          }

          await db.collection('users').doc(user.uid).update(rewardUpdate);
          localStorage.setItem(processedKey, 'true');
          return;
        }

        const session = await response.json();
        const rewardUsed = session.metadata?.rewardUsed === 'true';

        // Update rewards
        const userDoc = await db.collection('users').doc(user.uid).get();
        const userData = userDoc.data();
        const currentCount = (userData.rewards && userData.rewards.orderCount) || 0;
        const newCount = currentCount + 1;

        const rewardUpdate = { 'rewards.orderCount': newCount };

        if (rewardUsed) {
          rewardUpdate['rewards.rewardAvailable'] = false;
        } else if (newCount % 5 === 0) {
          rewardUpdate['rewards.rewardAvailable'] = true;
        }

        await db.collection('users').doc(user.uid).update(rewardUpdate);
        localStorage.setItem(processedKey, 'true');
      } catch (error) {
        console.error('Error updating rewards:', error);
      }
    }

    // Wait for auth state before loading
    auth.onAuthStateChanged(function() {
      loadOrderDetails();
    });
  </script>

</body>
</html>
